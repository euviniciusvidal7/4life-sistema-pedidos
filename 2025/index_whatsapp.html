<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>WhatsApp - Dr. Bruno Celso</title>
    <link rel="icon" href="https://static.whatsapp.net/rsrc.php/v3/yP/r/rYZqPCBaG70.png" type="image/x-icon">
    
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    
    fbq('init', '1332485478002907');
    fbq('track', 'PageView');
    
    // Configura√ß√£o da API de Convers√µes do Meta
    const META_ACCESS_TOKEN = 'EAAWWBU3BJdwBO5ov7wVRT07byZBJPffTqPkRGTJ9F8Y0yoPeaFIbL2NvM8ZA4B0fwIPHNoIZCtZCniAgcGlv1Of9yZBShZCWmKWkb6TUyoqpTagl7owlwZCufRKYxe9x45uHUfowiF9V0HvIe6ZAGgvShZCLx6h5awqrHkKk6sYrd6TiMX9Bp4NNWKCuZBLNmm96IzCQZDZD';
    const META_DATASET_ID = '1332485478002907';
    
    // Fun√ß√£o para gerar hash SHA-256
    async function sha256(message) {
        try {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            console.error('Erro ao gerar hash SHA-256:', error);
            return message; // Fallback sem hash
        }
    }
    
    // Fun√ß√£o para enviar eventos para a API de Convers√µes do Meta
    async function sendMetaConversionEvent(eventName, userData = {}, customData = {}) {
        try {
            // Primeiro, sempre enviar via Meta Pixel (mais confi√°vel)
            if (typeof fbq !== 'undefined') {
                fbq('track', eventName, customData);
                console.log(`Meta Pixel Event '${eventName}' enviado`);
            }
            
            // Verificar se temos token v√°lido para API de Convers√µes
            if (!META_ACCESS_TOKEN || META_ACCESS_TOKEN.length < 100) {
                console.warn('Token de acesso do Meta inv√°lido ou incompleto');
                return;
            }
            
            const eventTime = Math.floor(Date.now() / 1000);
            
            // Preparar dados do usu√°rio com hash - CORRIGIDO conforme melhores pr√°ticas
            const userDataHashed = {};
            
            // PAR√ÇMETROS OBRIGAT√ìRIOS (sempre incluir)
            userDataHashed.client_user_agent = navigator.userAgent;
            
            // PAR√ÇMETROS DE ALTA QUALIDADE (recomendados pelo Facebook)
            
            // Email (alta prioridade)
            if (userData.email && userData.email.trim()) {
                userDataHashed.em = [await sha256(userData.email.toLowerCase().trim())];
            }
            
            // Telefone (alta prioridade)
            if (userData.phone && userData.phone.trim()) {
                const cleanPhone = userData.phone.replace(/\D/g, '');
                const phoneWithCountry = cleanPhone.startsWith('351') ? cleanPhone : '351' + cleanPhone;
                userDataHashed.ph = [await sha256(phoneWithCountry)];
            }
            
            // Nome completo (alta prioridade)
            if (userData.firstName && userData.firstName.trim()) {
                userDataHashed.fn = [await sha256(userData.firstName.toLowerCase().trim())];
            }
            if (userData.lastName && userData.lastName.trim()) {
                userDataHashed.ln = [await sha256(userData.lastName.toLowerCase().trim())];
            }
            
            // IP do cliente (alta prioridade)
            try {
                const clientIP = await getClientIP();
                if (clientIP && clientIP.trim()) {
                    userDataHashed.client_ip_address = clientIP;
                }
            } catch (error) {
                console.warn('N√£o foi poss√≠vel obter IP do cliente');
            }
            
            // Cookies do Facebook (fbp e fbc) - IMPORTANTES para matching
            try {
                // Tentar obter fbp (Facebook Browser ID)
                const fbp = getCookie('_fbp');
                if (fbp) {
                    userDataHashed.fbp = fbp;
                }
                
                // Tentar obter fbc (Facebook Click ID)
                const fbc = getCookie('_fbc') || getUrlParameter('fbclid');
                if (fbc) {
                    userDataHashed.fbc = fbc.startsWith('fb.') ? fbc : `fb.1.${Date.now()}.${fbc}`;
                }
            } catch (error) {
                console.warn('Erro ao obter cookies do Facebook:', error);
            }
            
            // VALIDA√á√ÉO: Verificar se temos dados suficientes de ALTA QUALIDADE
            const hasHighQualityData = userDataHashed.em || userDataHashed.ph || 
                                     (userDataHashed.fn && userDataHashed.ln) || 
                                     userDataHashed.client_ip_address;
            
            if (!hasHighQualityData) {
                console.warn('‚ö†Ô∏è Dados insuficientes de alta qualidade para API de Convers√µes - usando apenas Meta Pixel');
                return;
            }
            
            // Preparar custom_data melhorado
            const enhancedCustomData = {
                ...customData,
                currency: 'EUR'
            };
            
            // Adicionar valor se for evento de compra
            if (eventName === 'Purchase' && !enhancedCustomData.value) {
                enhancedCustomData.value = 97.00;
            }
            
            // Gerar event_id √∫nico para deduplica√ß√£o
            const eventId = `${eventName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const eventData = {
                data: [{
                    event_name: eventName,
                    event_time: eventTime,
                    action_source: 'website',
                    event_source_url: window.location.href,
                    user_data: userDataHashed,
                    custom_data: enhancedCustomData,
                    event_id: eventId,
                    opt_out: false
                }]
            };
            
            // Log para debug (remover em produ√ß√£o)
            console.log('üìä Dados enviados para Meta API:', {
                event_name: eventName,
                user_data_keys: Object.keys(userDataHashed),
                has_email: !!userDataHashed.em,
                has_phone: !!userDataHashed.ph,
                has_name: !!(userDataHashed.fn && userDataHashed.ln),
                has_ip: !!userDataHashed.client_ip_address,
                has_fbp: !!userDataHashed.fbp,
                has_fbc: !!userDataHashed.fbc
            });
            
            // Enviar para a API de Convers√µes com timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
            
            const response = await fetch(`https://graph.facebook.com/v18.0/${META_DATASET_ID}/events?access_token=${META_ACCESS_TOKEN}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventData),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const responseData = await response.json();
                console.log(`‚úÖ Meta Conversion API Event '${eventName}' enviado com sucesso:`, responseData);
                
                // Verificar se h√° avisos sobre qualidade de matching
                if (responseData.events_received && responseData.events_received > 0) {
                    console.log(`üìà Eventos recebidos: ${responseData.events_received}`);
                }
            } else {
                const errorText = await response.text();
                console.error('‚ùå Erro na API de Convers√µes do Meta:', errorText);
                
                // Tentar parsear o erro para mais detalhes
                try {
                    const errorData = JSON.parse(errorText);
                    if (errorData.error) {
                        console.error('üîç Detalhes do erro:', {
                            message: errorData.error.message,
                            code: errorData.error.code,
                            subcode: errorData.error.error_subcode,
                            user_title: errorData.error.error_user_title,
                            user_msg: errorData.error.error_user_msg
                        });
                        
                        if (errorData.error.error_subcode === 2804050) {
                            console.warn('‚ö†Ô∏è Dados insuficientes do cliente - melhorando coleta de dados...');
                        }
                    }
                } catch (parseError) {
                    console.error('Erro ao parsear resposta de erro:', parseError);
                }
            }
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('‚è±Ô∏è Timeout na API de Convers√µes do Meta');
            } else {
                console.error('‚ùå Erro ao enviar evento Meta:', error);
            }
            
            // Garantir que o pixel foi enviado mesmo com erro na API
            if (typeof fbq !== 'undefined') {
                fbq('track', eventName, customData);
            }
        }
    }
    
    // Fun√ß√£o auxiliar para obter cookies
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    // Fun√ß√£o auxiliar para obter par√¢metros da URL
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    
    // Fun√ß√£o para obter IP do cliente (para melhor matching)
    async function getClientIP() {
        try {
            // Tentar m√∫ltiplos servi√ßos para obter o IP
            const services = [
                'https://api.ipify.org?format=json',
                'https://ipapi.co/json/',
                'https://httpbin.org/ip'
            ];
            
            for (const service of services) {
                try {
                    const response = await fetch(service, { timeout: 3000 });
                    const data = await response.json();
                    
                    // Diferentes servi√ßos retornam o IP em campos diferentes
                    const ip = data.ip || data.origin || data.query;
                    if (ip) {
                        return ip;
                    }
                } catch (error) {
                    console.warn(`Falha ao obter IP de ${service}:`, error);
                    continue;
                }
            }
            
            return null;
        } catch (error) {
            console.warn('Erro ao obter IP do cliente:', error);
            return null;
        }
    }
    
    // Verificar se o pixel est√° funcionando
    window.addEventListener('load', function() {
        setTimeout(function() {
            if (typeof fbq === 'undefined') {
                console.error('Meta Pixel n√£o carregou corretamente');
                // Fallback: carregar pixel via imagem
                const img = new Image();
                img.src = 'https://www.facebook.com/tr?id=1332485478002907&ev=PageView&noscript=1';
            } else {
                console.log('Meta Pixel carregado com sucesso');
                // Enviar PageView adicional ap√≥s carregamento completo
                fbq('track', 'PageView');
            }
        }, 2000);
    });
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1332485478002907&ev=PageView&noscript=1"/></noscript>
    <!-- End Meta Pixel Code -->
    
    <!-- Biblioteca Iscroll para garantir rolagem suave mobile/desktop-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.2.0/iscroll.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --whatsapp-teal: #075E54;
            --whatsapp-teal-light: #128C7E;
            --whatsapp-green: #25D366;
            --whatsapp-light-green: #DCF8C6;
            --whatsapp-chat-bg: #E5DDD5;
            --whatsapp-panel-bg: #EDEDED;
            --whatsapp-drawer-bg: #F0F2F5;
            --whatsapp-icon-gray: #919191;
            --whatsapp-text: #303030;
            --whatsapp-secondary-text: #667781;
            --whatsapp-outgoing-chat: #DCF8C6;
            --whatsapp-border: #D1D7DB;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            background-color: var(--whatsapp-panel-bg);
            margin: 0;
            padding: 0;
            touch-action: manipulation;
        }
        
        body {
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
        }
        
        .whatsapp-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--whatsapp-panel-bg);
            overflow: hidden;
        }
        
        /* Header Styles */
        .header {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background-color: var(--whatsapp-teal);
            background-image: linear-gradient(to right, var(--whatsapp-teal), var(--whatsapp-teal-light));
            color: white;
            z-index: 100;
            height: 60px;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.6);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .profile-pic:hover {
            transform: scale(1.05);
            border: 2px solid rgba(255,255,255,0.9);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
        }
        
        .profile-name {
            font-size: 16px;
            font-weight: 500;
            color: white;
            margin-bottom: 2px;
        }
        
        .profile-status {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .header-icons {
            margin-left: auto;
            display: flex;
        }
        
        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-left: 8px;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .header-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .header-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .header-icon:active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(1px);
        }
        
        .header-icon:active::after {
            animation: rippleWhite 0.6s ease-out;
        }
        
        @keyframes rippleWhite {
            0% {
                opacity: 1;
                transform: scale(0, 0);
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Chat Body Styles */
        .chat-body {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--whatsapp-chat-bg);
            background-image: url('https://4lifenutrition.site/Assets/background.webp');
            background-repeat: repeat;
        }
        
        .profile-section {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            background-color: var(--whatsapp-panel-bg);
            padding: 20px;
            transition: all 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform-origin: center;
        }
        
        .profile-section-inner {
            max-width: 400px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            animation: profileAppear 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        @keyframes profileAppear {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            70% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .large-profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 16px;
            border: 4px solid var(--whatsapp-light-green);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: profilePicAppear 1s ease-out;
            transition: all 0.3s ease;
        }
        
        .large-profile-pic:hover {
            transform: scale(1.03) rotate(2deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes profilePicAppear {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0);
            }
        }
        
        .profile-section h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--whatsapp-text);
            margin-bottom: 4px;
            animation: fadeInUp 0.8s ease-out 0.3s both;
            text-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .username {
            font-size: 15px;
            color: var(--whatsapp-secondary-text);
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 0.5s both;
            position: relative;
            display: inline-block;
        }
        
        .username::after {
            content: '';
            position: absolute;
            width: 0;
            height: 1px;
            bottom: -2px;
            left: 50%;
            background-color: var(--whatsapp-teal-light);
            transition: all 0.6s ease;
            transform: translateX(-50%);
        }
        
        .username:hover::after {
            width: 80%;
        }
        
        .not-friends {
            font-size: 13px;
            color: var(--whatsapp-secondary-text);
            margin-bottom: 16px;
            padding: 8px 12px;
            background-color: #f0f2f5;
            border-radius: 18px;
            display: inline-block;
        }
        
        .education {
            font-size: 13px;
            color: var(--whatsapp-secondary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 16px;
            padding: 8px 0;
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .education svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            fill: var(--whatsapp-secondary-text);
        }
        
        /* Adicionando estilos para especialidades */
        .specialties {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }
        
        .specialty-tag {
            font-size: 12px;
            color: var(--whatsapp-teal);
            background-color: rgba(37, 211, 102, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            margin: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: fadeInTag 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .specialty-tag:nth-child(1) {
            animation-delay: 0.1s;
        }
        
        .specialty-tag:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .specialty-tag:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        .specialty-tag:nth-child(4) {
            animation-delay: 0.4s;
        }
        
        .specialty-tag:hover {
            background-color: rgba(37, 211, 102, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        @keyframes fadeInTag {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Adicionando estilo para bot√£o de iniciar conversa */
        .start-conversation {
            background-color: var(--whatsapp-green);
            background-image: linear-gradient(to right bottom, var(--whatsapp-green), #22c35e);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .start-conversation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: all 0.6s ease;
        }
        
        .start-conversation:hover {
            background-color: #22c35e;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .start-conversation:hover::before {
            left: 100%;
        }
        
        .start-conversation:active {
            transform: scale(0.98) translateY(0);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        
        /* Adicionando estilo para anima√ß√£o de pulso */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.4);
            }
            
            70% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(37, 211, 102, 0);
            }
            
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }
        
        /* Footer Styles */
        .footer {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-top: 1px solid var(--whatsapp-border);
            background-color: var(--whatsapp-panel-bg);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            flex-shrink: 0;
            height: 60px;
            padding-bottom: calc(8px + var(--safe-area-inset-bottom));
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Input actions and button styles */
        .input-actions {
            display: flex;
            align-items: center;
            margin-right: 8px;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: 0 2px;
            color: var(--whatsapp-icon-gray);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(0, 0, 0, 0.1);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .action-btn:hover {
            color: var(--whatsapp-teal-light);
            background-color: rgba(0, 0, 0, 0.03);
            transform: translateY(-1px);
        }
        
        .action-btn:active {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateY(1px);
        }
        
        .action-btn:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                opacity: 1;
                transform: scale(0, 0);
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Message input field styles */
        .message-input-container {
            flex: 1;
            position: relative;
        }
        
        .message-input {
            width: 100%;
            border: none;
            border-radius: 21px;
            background-color: white;
            padding: 9px 12px;
            font-size: 15px;
            min-height: 42px;
            outline: none;
            color: var(--whatsapp-text);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 5px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }
        
        .message-input:focus {
            box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 5px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }
        
        .message-input::placeholder {
            color: var(--whatsapp-secondary-text);
        }
        
        .send-btn {
            width: auto;
            height: 40px;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 8px;
            cursor: pointer;
            background-color: var(--whatsapp-green);
            background-image: linear-gradient(to right bottom, var(--whatsapp-green), #22c35e);
            color: white;
            padding-right: 15px;
            padding-left: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 7px rgba(0,0,0,0.15);
            background-image: linear-gradient(to right bottom, #2ad370, var(--whatsapp-green));
        }
        
        .send-btn:active {
            background-color: #22c35e;
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .send-btn svg {
            transition: transform 0.3s ease;
        }
        
        .send-btn:hover svg {
            transform: translateX(2px);
        }
        
        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 0;
            transition: opacity 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28), 
                        filter 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        /* Anima√ß√£o para a sa√≠da do perfil */
        @keyframes fadeOutProfile {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            20% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }
        
        .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            width: 100%;
            margin: 0 auto;
        }
        
        .loading-dots div {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--whatsapp-green);
            margin: 0 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transform-origin: center bottom;
        }
        
        .loading-dots div:nth-child(1) {
            animation: dotBounce 1.2s -0.32s infinite cubic-bezier(.45,.05,.55,.95);
        }
        
        .loading-dots div:nth-child(2) {
            animation: dotBounce 1.2s -0.16s infinite cubic-bezier(.45,.05,.55,.95);
        }
        
        .loading-dots div:nth-child(3) {
            animation: dotBounce 1.2s 0s infinite cubic-bezier(.45,.05,.55,.95);
        }
        
        @keyframes dotBounce {
            0%, 100% { 
                transform: translateY(0) scale(1);
                background-color: var(--whatsapp-green);
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            30% { 
                transform: translateY(-10px) scale(1.1);
                background-color: var(--whatsapp-teal-light);
                box-shadow: 0 10px 10px rgba(0,0,0,0.2);
            }
            60% { 
                transform: translateY(3px) scale(0.95);
                background-color: var(--whatsapp-green);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: var(--whatsapp-teal);
            font-weight: 500;
            animation: pulseText 1.5s infinite alternate ease-in-out;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            width: 100%;
            text-align: center;
        }
        
        @keyframes pulseText {
            from {
                opacity: 0.7;
            }
            to {
                opacity: 1;
            }
        }
        
        .cta-text {
            font-size: 12px;
            color: var(--whatsapp-secondary-text);
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cta-text svg {
            width: 14px;
            height: 14px;
            margin-right: 4px;
            fill: var(--whatsapp-green);
        }
        
        /* player de √°udio personalizado */
        .whatsapp-audio-player {
            max-width: 90%;
            width: 380px;
            min-width: 180px;
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 7.5px;
            padding: 8px 8px 8px 6px;
            margin: 5px 0;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            height: 70px;
        }
        
        /* Quando o player est√° dentro de uma mensagem, ele n√£o precisa de seu pr√≥prio background e borda */
        .message-content .whatsapp-audio-player {
            background-color: transparent;
            box-shadow: none;
            padding: 0;
            margin: 5px 0 8px 0;
            max-width: 100%;
            width: 100%;
        }
        
        .whatsapp-audio-player .play-button {
            background-color: white;
            color: #323333;
            border: none;
            border-radius: 50%;
            width: 43px;
            height: 43px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: 0 8px 0 2px;
            flex-shrink: 0;
            transition: background-color 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .whatsapp-audio-player .play-button svg {
            fill: #00a884;
        }
        
        /* Aumentando a √°rea de clique do bot√£o de play */
        .whatsapp-audio-player .play-button,
        .audio-reply-player .play-button {
            width: 55px;
            height: 55px;
            position: relative;
            z-index: 10;
        }
        
        .whatsapp-audio-player .play-button::after,
        .audio-reply-player .play-button::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            z-index: 5;
            cursor: pointer;
        }
        
        .whatsapp-audio-player .waveform {
            height: 24px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 8px;
        }
        
        .whatsapp-audio-player .waveform span {
            flex: 1;
            height: 100%;
            min-width: 1.5px;
            max-width: 2.5px;
            margin: 0 1px;
            background-color: rgba(0, 0, 0, 0.12);
            display: inline-block;
            transition: background-color 0.3s ease;
            border-radius: 1px;
        }
        
        .whatsapp-audio-player .time {
            font-size: 11px;
            color: var(--whatsapp-secondary-text);
            min-width: 42px;
            text-align: right;
            font-weight: 500;
        }
        
        .message-out .whatsapp-audio-player {
            background-color: #d9fdd3;
        }
        
        .message-out .whatsapp-audio-player .waveform span {
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        /* Adicionar suporte para interface mobile */
        @media (max-width: 480px) {
            .whatsapp-audio-player {
                width: 90%;
                max-width: 320px;
                min-width: 250px;
                padding: 6px 6px 6px 4px;
                height: 75px; /* Aumentando a altura do player */
            }
            
            .whatsapp-audio-player .play-button,
            .audio-reply-player .play-button {
                width: 36px;
                height: 36px;
                margin-right: 6px;
            }
            
            .whatsapp-audio-player .play-button svg,
            .audio-reply-player .play-button svg {
                width: 37px;
                height: 75px;
            }
            
            .whatsapp-audio-player .waveform {
                height: 20px;
                margin: 0 6px;
            }
            
            .whatsapp-audio-player .waveform span {
                min-width: 1px;
                max-width: 2px;
                margin: 0 1px;
            }
            
            /* Reduzir o n√∫mero de barras no waveform para dispositivos m√≥veis (corre√ß√£o de largura) */
            .whatsapp-audio-player .waveform span:nth-child(4n+3) {
                display: none;
            }
            
            .whatsapp-audio-player .time {
                min-width: 36px;
                font-size: 10px;
            }
            
            /* Ajustar tamanho m√°ximo da mensagem em dispositivos m√≥veis (corre√ß√£o de tamanho)*/
            .chat-message {
                max-width: 90%;
            }
        }
        
        /* Adicionar estilo para mensagens de erro de endere√ßo */
        .address-error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Adaptar a bolha de √°udio para √°udios recebidos */
        .message-in .whatsapp-audio-player {
            background-color: white;
            border-radius: 0px 7.5px 7.5px 7.5px;
            position: relative;
        }
        
        /* Adicionar a seta para o bal√£o de √°udio recebido (entrada) */
        .message-in .whatsapp-audio-player::before {
            content: "";
            position: absolute;
            top: 0;
            left: -8px;
            width: 8px;
            height: 13px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".13" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="white" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg>');
            background-repeat: no-repeat;
        }
        
        /* Adaptar a bolha de √°udio para √°udios enviados */
        .message-out .whatsapp-audio-player {
            background-color: var(--whatsapp-light-green);
            border-radius: 7.5px 0px 7.5px 7.5px;
            position: relative;
        }
        
        /* Adicionar a seta para o bal√£o de √°udio enviado (sa√≠da) */
        .message-out .whatsapp-audio-player::before {
            content: "";
            position: absolute;
            top: 0;
            right: -8px;
            width: 8px;
            height: 13px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".13" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="%23DCF8C6" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg>');
            background-repeat: no-repeat;
            transform: scaleX(-1);
        }
        
        /* Quando o player est√° dentro de uma mensagem, o fundo deve ser transparente e sem a seta */
        .message-in .message-content .whatsapp-audio-player,
        .message-out .message-content .whatsapp-audio-player {
            background-color: transparent;
            box-shadow: none;
            border-radius: 0;
        }
        
        .message-in .message-content .whatsapp-audio-player::before,
        .message-out .message-content .whatsapp-audio-player::before {
            display: none;
        }
        
        /* Estilo para o container de tempo e status dentro do player de √°udio */
        .message-time-container {
            position: absolute;
            right: 8px;
            bottom: -11px;
            display: flex;
            align-items: center;
            font-size: 11px;
            color: rgba(0, 0, 0, 0.6);
            z-index: 2;
        }
        
        /* Estilos para o chat principal e container de mensagens */
        .chat-container {
            position: absolute;
            top: 60px;
            bottom: 60px;
            left: 0;
            right: 0;
            z-index: 5;
            display: none;
            background-color: var(--whatsapp-chat-bg);
            background-image: url('https://4lifenutrition.site/Assets/background.webp');
            background-repeat: repeat;
            overflow: hidden; /* Importante para o iScroll funcionar */
            transition: all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        .messages-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100%;
            padding-bottom: 20px;
        }
        
        /* Estilos para as bolhas de mensagem WhatsApp */
        .chat-message {
            position: relative;
            max-width: 75%;
            margin: 4px 8px;
            font-size: 18px;
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
            animation: messageAppear 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform-origin: left center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        
        .chat-message:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        @keyframes messageAppear {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.96);
            }
            70% {
                opacity: 1;
                transform: translateY(-2px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes messageAppearIn {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.94);
            }
            70% {
                opacity: 1;
                transform: translateX(2px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        @keyframes messageAppearOut {
            0% {
                opacity: 0;
                transform: translateX(20px) scale(0.94);
            }
            70% {
                opacity: 1;
                transform: translateX(-2px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .chat-message.message-in {
            align-self: flex-start;
            transform-origin: left center;
            animation: messageAppearIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            margin-bottom: 2px;
        }
        
        .chat-message.message-out {
            align-self: flex-end;
            margin-left: auto;
            flex-direction: row-reverse;
            transform-origin: right center;
            animation: messageAppearOut 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            margin-bottom: 2px;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-out .message-avatar {
            display: none;
        }
        
        .message-content {
            position: relative;
            padding: 6px 7px 8px 9px;
            border-radius: 7.5px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
            transition: all 0.3s ease;
            overflow: hidden;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            /* Sistema de largura mais inteligente */
            width: fit-content;
            max-width: min(65vw, 320px);
            min-width: 48px;
        }
        
        /* Remover completamente o efeito de brilho que estava causando a caixa transparente feia */
        .message-content::after {
            display: none !important;
        }
        
        .chat-message:hover .message-content::after {
            display: none !important;
        }
        
        .message-in .message-content {
            background-color: #ffffff;
            color: #111b21;
            border-radius: 0px 7.5px 7.5px 7.5px;
            /* Largura mais precisa para mensagens recebidas */
            max-width: min(65vw, 320px);
        }
        
        .message-out .message-content {
            background-color: #d9fdd3;
            color: #111b21;
            border-radius: 7.5px 0px 7.5px 7.5px;
            /* Largura mais precisa para mensagens enviadas */
            max-width: min(65vw, 320px);
        }
        
        /* Estilo para v√≠deos dentro dos bal√µes */
        .message-content iframe {
            max-width: 100%;
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 4px 0 8px 0;
            display: block;
            border: none;
            background: #000;
        }
        
        /* Ajuste espec√≠fico para v√≠deos do YouTube */
        .message-content iframe[src*="youtube"] {
            width: min(280px, calc(65vw - 20px));
            height: calc(min(280px, calc(65vw - 20px)) * 0.5625); /* Propor√ß√£o 16:9 */
            max-width: 100%;
            min-width: 200px;
            min-height: 112px;
        }
        
        /* Ajustes para dispositivos m√≥veis */
        @media only screen and (max-width: 768px) {
            .message-content {
                /* Sistema de largura mais inteligente para mobile */
                max-width: min(75vw, 280px);
                min-width: 44px;
                padding: 6px 7px 8px 9px;
            }
            
            .message-out .message-content {
                max-width: min(75vw, 280px);
            }
            
            .message-in .message-content {
                max-width: min(75vw, 280px);
            }
            
            .chat-message {
                max-width: 85vw;
                margin-bottom: 2px;
            }
            
            /* Ajuste melhorado para v√≠deos no mobile */
            .message-content iframe[src*="youtube"] {
                width: min(240px, calc(75vw - 30px));
                height: calc(min(240px, calc(75vw - 30px)) * 0.5625);
                max-width: calc(100% - 10px);
                min-width: 180px;
                min-height: 101px;
            }
            
            .typing-indicator {
                max-width: 70px;
                padding: 6px 10px;
            }
            
            .typing-indicator span {
                width: 6px;
                height: 6px;
                margin: 0 1px;
            }
        }
        
        /* Ajustes para telas muito pequenas */
        @media only screen and (max-width: 480px) {
            .message-content {
                max-width: min(80vw, 260px);
                min-width: 40px;
                padding: 5px 6px 7px 8px;
            }
            
            .message-out .message-content {
                max-width: min(80vw, 260px);
            }
            
            .message-in .message-content {
                max-width: min(80vw, 260px);
            }
            
            .chat-message {
                max-width: 90vw;
            }
            
            /* V√≠deos ainda menores para telas muito pequenas */
            .message-content iframe[src*="youtube"] {
                width: min(200px, calc(80vw - 25px));
                height: calc(min(200px, calc(80vw - 25px)) * 0.5625);
                min-width: 160px;
                min-height: 90px;
            }
        }
        
        /* Ajustes para telas extra pequenas */
        @media only screen and (max-width: 360px) {
            .message-content {
                max-width: min(85vw, 240px);
                min-width: 36px;
            }
            
            .message-out .message-content {
                max-width: min(85vw, 240px);
            }
            
            .message-in .message-content {
                max-width: min(85vw, 240px);
            }
            
            /* V√≠deos para telas extra pequenas */
            .message-content iframe[src*="youtube"] {
                width: min(180px, calc(85vw - 20px));
                height: calc(min(180px, calc(85vw - 20px)) * 0.5625);
                min-width: 140px;
                min-height: 79px;
            }
        }
        
        .message-in .message-content::before {
            content: "";
            position: absolute;
            top: 0;
            left: -8px;
            width: 8px;
            height: 13px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".13" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="white" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg>');
            background-repeat: no-repeat;
            transition: transform 0.3s ease;
        }
        
        .message-out .message-content::before {
            content: "";
            position: absolute;
            top: 0;
            right: -8px;
            width: 8px;
            height: 13px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".13" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="%23d9fdd3" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg>');
            background-repeat: no-repeat;
            transform: scaleX(-1);
            transition: transform 0.3s ease;
        }
        
        .chat-message.message-in:hover .message-content::before {
            transform: translateX(-1px) scale(1.05);
        }
        
        .chat-message.message-out:hover .message-content::before {
            transform: scaleX(-1) translateX(-1px) scale(1.05);
        }
        
        .message-text {
            margin-bottom: 4px;
            font-size: 14.2px;
            line-height: 19px;
            color: #111b21;
            font-weight: 400;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .message-text strong {
            font-weight: 600;
        }
        
        .message-text em {
            font-style: italic;
        }
        
        .message-text a {
            color: #027eb5;
            text-decoration: underline;
        }
        
        .message-text ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .message-time {
            font-size: 11px;
            color: #667781;
            float: right;
            margin-left: 4px;
            margin-bottom: -2px;
            margin-top: 4px;
            font-weight: 400;
            direction: ltr;
            unicode-bidi: isolate;
        }

        /* Ajuste especial para mensagens com reply */
        .reply-container .message-time {
            margin-bottom: 0px;
        }
        
        .message-status {
            display: inline-block;
            width: 16px;
            height: 11px;
            margin-left: 3px;
            vertical-align: text-bottom;
            position: relative;
            color: var(--whatsapp-teal-light);
            font-size: 14px;
        }
        
        /* Estilo para a imagem na mensagem */
        .message-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-top: 5px;
        }
        
        /* Estilo para a barra de digitando */
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 8px 16px;
            max-width: 80px;
            width: max-content;
            background-color: white;
            border-radius: 16px;
            padding: 8px 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        .typing-indicator::before {
            content: "";
            position: absolute;
            top: 0;
            left: -8px;
            width: 8px;
            height: 13px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".13" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="white" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg>');
            background-repeat: no-repeat;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            margin: 0 1.5px;
            background-color: var(--whatsapp-teal-light);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.3s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite;
            opacity: 0.8;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.15s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.8;
            }
            30% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Ajustes para iPad e iPhone com entalhe (notch) */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: calc(10px + env(safe-area-inset-top));
                height: calc(60px + env(safe-area-inset-top));
            }
            
            .chat-body {
                height: calc(100% - 60px - 52px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            
            .footer {
                padding-bottom: calc(8px + env(safe-area-inset-bottom));
            }
        }
        
        /* Media query para dispositivos m√≥veis */
        @media only screen and (max-width: 768px) {
            /* Garantir que o chat container tenha rolagem pr√≥pria e independente */
            .chat-container {
                position: fixed;
                top: 60px; /* Altura do header */
                bottom: 60px; /* Altura do footer */
                left: 0;
                right: 0;
                height: auto;
                overflow-y: scroll !important;
                -webkit-overflow-scrolling: touch !important;
                z-index: 50;
            }
            
            /* Manter o footer fixo na parte inferior */
            .footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 101;
            }
            
            /* O header tamb√©m fica fixo */
            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
            }
            
            /* Estilos espec√≠ficos para iOS */
            .ios-scroll-fix {
                -webkit-overflow-scrolling: touch !important;
                position: fixed !important;
                overflow: scroll !important;
                height: auto !important;
            }
            
            .ios-body-fix {
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
                overflow: hidden !important;
            }
            
            /* Melhorias de desempenho para rolagem */
            .chat-container {
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }
            
            /* Estilo para bot√£o de rolagem */
            #scroll-down-btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* Input de mensagem mais nativo e responsivo */
            .message-input {
                -webkit-appearance: none;
                appearance: none;
                resize: none;
            }
            
            /* Ajuste para o corpo quando o teclado est√° vis√≠vel */
            body.keyboard-open {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            
            /* Garantir que a √°rea de mensagens use toda a altura dispon√≠vel */
            .messages-container {
                padding-bottom: 60px; /* Espa√ßo adicional para garantir que a √∫ltima mensagem seja vis√≠vel */
            }
            
            /* Tamanho fixo para a √°rea de chat no iOS */
            .chat-body {
                -webkit-overflow-scrolling: touch;
            }
            
            
            .typing-indicator {
                max-width: 70px;
                padding: 6px 10px;
            }
            
            .typing-indicator span {
                width: 6px;
                height: 6px;
                margin: 0 1px;
            }
        }
        
        /* Adicionar CSS para fixar problemas de rolagem */
        body.chat-started {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        .chat-container {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            /* Esconder a barra de rolagem nativa quando o iScroll estiver ativo */
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE/Edge */
        }
        
        .chat-container::-webkit-scrollbar {
            width: 0px !important; /* Chrome/Safari/Opera */
            display: none !important;
        }
        
        /* Estilizar apenas a barra de rolagem do iScroll */
        .iScrollVerticalScrollbar {
            position: absolute;
            z-index: 100;
            width: 7px !important;
            bottom: 2px;
            top: 2px;
            right: 2px !important;
            overflow: hidden;
        }
        
        .iScrollIndicator {
            position: absolute;
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 4px !important;
            width: 100%;
            transition-duration: 0ms;
            display: block;
            height: 100px;
            transform: translate(0px, 0px);
            transition-timing-function: cubic-bezier(0.33, 0.66, 0.66, 1);
            border: 0px !important;
        }
        
        .messages-container {
            padding-bottom: 80px !important;
        }
        
        /* Estilo para visualiza√ß√£o ampliada de imagens */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .image-modal-content {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        /* Adicionar CSS para indicador de zoom nas imagens */
        .message-image-container {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        /* Adicionar estilos para a funcionalidade de resposta (reply) ao CSS existente */
        /* Estilos para o componente de resposta */
        .reply-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 3px;
            padding: 4px 6px;
            border-left: 3px solid var(--whatsapp-teal-light);
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            position: relative;
            max-width: 100%;
            overflow: hidden;
            margin-top: 2px;
        }
        
        .message-in .reply-container {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .message-out .reply-container {
            background-color: rgba(0, 0, 0, 0.07);
        }
        
        .reply-sender {
            font-size: 12px;
            font-weight: 600;
            color: var(--whatsapp-teal-light);
            margin-bottom: 0;
        }
        
        .reply-content {
            font-size: 12px;
            color: var(--whatsapp-secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            line-height: 1.2;
        }
        
        .reply-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 8px;
            flex-shrink: 0;
            float: right;
            margin-left: 8px;
        }
        
        .reply-wrapper {
            display: flex;
            align-items: center;
            max-width: 100%;
            justify-content: space-between;
        }
        
        .reply-text-container {
            flex: 1;
            min-width: 0;
        }
        
        /* Estilos espec√≠ficos para √°udio com resposta */
        .message-content .whatsapp-audio-player {
            margin-top: 5px;
            display: flex;
            align-items: center;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            height: auto;
            min-height: 55px; /* Aumentado novamente */
            position: relative; /* Para posicionamento absoluto dos elementos de tempo */
            padding-bottom: 20px; /* Espa√ßo para os timestamps abaixo */
        }
        
        /* Estilos para o player de √°udio com resposta */
        .audio-reply-player {
            width: 100%;
            padding: 0 !important;
            box-shadow: none !important;
            background-color: transparent !important;
        }
        
        .audio-reply-player .play-button {
            margin-right: 8px;
            flex-shrink: 0;
            width: 43px;
            height: 43px;
            background-color: white;
            color: #323333;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .audio-reply-player .play-button svg {
            fill: #00a884;
        }
        
        .audio-reply-player .waveform {
            flex: 1;
            margin: 0 8px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Estilo para as barras no waveform */
        .audio-reply-player .waveform span {
            flex: 1;
            height: 100%;
            min-width: 1.5px;
            max-width: 2.5px;
            margin: 0 1px;
            background-color: rgba(0, 0, 0, 0.12);
            display: inline-block;
            transition: background-color 0.3s ease;
            border-radius: 1px;
        }
        
        /* Estilo para as barras ativas no waveform */
        .audio-reply-player .waveform span.active {
            background-color: #00a884 !important;
        }
        
        /* Ajustes para o container de tempo em √°udios com resposta */
        .message-content .message-time-container {
            position: absolute;
            display: flex;
            align-items: center;
            bottom: -11px;
            left: 3px; /* Alinhado com o bot√£o de play como no player sem reply */
            margin-top: 0;
            float: none;
            margin-right: 0;
        }
        
        .reply-time {
            position: absolute !important;
            bottom: -11px !important;
            left: 3px !important; /* Alinhado com o bot√£o de play como no player sem reply */
            font-size: 11px !important;
            color: rgba(0, 0, 0, 0.6);
            margin: 0 !important;
        }
        
        /* Adaptar para dispositivos m√≥veis */
        @media (max-width: 480px) {
            .reply-image {
                width: 40px;
                height: 40px;
            }
            
            .reply-container {
                padding: 4px 6px;
            }
            
            .audio-reply-player .play-button {
                width: 36px;
                height: 36px;
                margin-right: 6px;
                background-color: white;
                color: #323333;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }
            
            .audio-reply-player .play-button svg {
                width: 37px;
                height: 75px;
                fill: #00a884;
            }
            
            .reply-sender, .reply-content {
                font-size: 12px;
            }
        }
        
        /* Estilos para avatar em √°udios de resposta */
        .reply-avatar {
            width: 35px !important; /* Aumentado */
            height: 35px !important; /* Aumentado */
            margin-left: 6px !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Para dispositivos m√≥veis, ajustar ainda mais */
        @media (max-width: 480px) {
            .reply-avatar {
                width: 22px !important;
                height: 22px !important;
            }
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        /* Adicionar CSS para indicador de zoom nas imagens */
        .message-image-container {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        /* Estilos para o popup de confirma√ß√£o de endere√ßo */
        .address-popup {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.7) !important;
            z-index: 9999 !important;
            justify-content: center !important;
            align-items: center !important;
            flex-direction: column !important;
            animation: fadeIn 0.3s ease-out;
            padding: 10px !important;
            box-sizing: border-box !important;
        }
        
        .address-popup[style*="flex"] {
            display: flex !important;
        }
        
        .address-popup-content {
            width: 90%;
            max-width: 400px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            70% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .address-popup-header {
            background-color: var(--whatsapp-teal);
            background-image: linear-gradient(to right, var(--whatsapp-teal), var(--whatsapp-teal-light));
            color: white;
            padding: 16px;
            position: relative;
            text-align: center;
        }
        
        .address-popup-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }

        /* Estilos para o bot√£o X do popup */
        .popup-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10001;
        }

        .popup-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            transform: scale(1.1);
        }

        .popup-close-btn:active {
            transform: scale(0.95);
        }

        /* Estilo para popup sem bot√£o X */
        .popup-no-close .popup-close-btn {
            display: none !important;
        }

        .address-popup-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .offer-section {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .delivery-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid var(--whatsapp-green);
        }
        
        .delivery-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--whatsapp-teal);
            margin-bottom: 5px;
        }
        
        .payment-info {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .price-discount {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #999;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .discounted-price {
            color: var(--whatsapp-teal);
            font-weight: bold;
            font-size: 18px;
        }
        
        .savings {
            background-color: var(--whatsapp-green);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .free-shipping {
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-section {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            color: var(--whatsapp-secondary-text);
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--whatsapp-border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--whatsapp-teal-light);
            box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.2);
            outline: none;
        }
        
        .form-control.readonly {
            background-color: #f8f8f8;
            cursor: default;
        }
        
        .edit-icon {
            position: absolute;
            right: 10px;
            top: 35px;
            color: var(--whatsapp-teal);
            cursor: pointer;
        }
        
        .address-block {
            border: 1px solid var(--whatsapp-border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: #f9f9f9;
        }
        
        .address-block-title {
            display: flex;
            align-items: center;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--whatsapp-text);
        }
        
        .address-block-title svg {
            margin-right: 8px;
            color: var(--whatsapp-teal);
        }
        
        .address-fields {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .address-submit-btn {
            background-color: var(--whatsapp-green);
            background-image: linear-gradient(to right bottom, var(--whatsapp-green), #22c35e);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .address-submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: all 0.6s ease;
        }
        
        .address-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .address-submit-btn:hover::before {
            left: 100%;
        }
        
        .address-submit-btn:active {
            transform: translateY(1px);
        }
        
        .payment-on-delivery {
            text-align: center;
            font-size: 13px;
            color: var(--whatsapp-secondary-text);
            margin-top: 8px;
        }
        
        .popup-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-top: 1px solid var(--whatsapp-border);
            background-color: #f8f8f8;
            font-size: 13px;
            color: var(--whatsapp-secondary-text);
        }
        
        .popup-footer svg {
            margin-right: 5px;
        }
        
        /* Estilos responsivos para dispositivos m√≥veis */
        @media (max-width: 480px) {
            .address-popup-content {
                width: 95%;
                max-width: 350px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .address-popup-header {
                padding: 12px;
            }
            
            .address-popup-header h2 {
                font-size: 16px;
            }
            
            .address-popup-body {
                padding: 15px;
            }
            
            .offer-section {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .delivery-image {
                width: 60px;
                height: 60px;
            }
            
            .delivery-title {
                font-size: 14px;
            }
            
            .discounted-price {
                font-size: 16px;
            }
            
            .form-control {
                font-size: 14px;
                padding: 8px 10px;
            }
            
            .address-submit-btn {
                padding: 10px;
                font-size: 15px;
            }
            
            .address-block {
                padding: 12px;
            }
        }
        
        /* Estilos para telas muito pequenas */
        @media (max-width: 360px) {
            .address-popup-content {
                width: 98%;
                max-width: 320px;
                max-height: 85vh;
            }
            
            .address-popup-header {
                padding: 10px;
            }
            
            .address-popup-header h2 {
                font-size: 14px;
            }
            
            .address-popup-body {
                padding: 12px;
            }
            
            .offer-section {
                padding: 10px;
                margin-bottom: 12px;
            }
            
            .delivery-image {
                width: 50px;
                height: 50px;
            }
            
            .delivery-title {
                font-size: 13px;
            }
            
            .discounted-price {
                font-size: 15px;
            }
            
            .form-control {
                font-size: 13px;
                padding: 7px 8px;
            }
            
            .address-submit-btn {
                padding: 8px;
                font-size: 14px;
            }
        }
        
        /* Ajuste especial para mensagens muito pequenas */
        .message-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 48px;
        }
        
        /* Garantir que mensagens com apenas emoji tenham tamanho adequado */
        .message-text {
            flex: 1;
            min-width: 20px;
        }
        
        /* Melhorar o alinhamento do tempo nas mensagens */
        .message-time {
            align-self: flex-end;
            flex-shrink: 0;
            margin-top: auto;
        }
        
        /* Ajuste para mensagens muito curtas */
        @media only screen and (max-width: 480px) {
            .message-content {
                min-width: 40px;
            }
        }
        
        @media only screen and (max-width: 360px) {
            .message-content {
                min-width: 36px;
            }
        }

        /* Anima√ß√£o para o cron√¥metro de urg√™ncia */
        @keyframes pulse-urgent {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 10px rgba(255, 71, 87, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 4px 15px rgba(255, 71, 87, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 10px rgba(255, 71, 87, 0.3);
            }
        }

        /* Estilo para quando o cron√¥metro est√° quase expirando */
        .countdown-urgent {
            animation: pulse-urgent 0.5s infinite !important;
            background: linear-gradient(45deg, #ff1744, #d50000) !important;
        }

        /* Estilos para o modal de imagem */
        .image-modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease;
        }

        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            animation: zoomInModal 0.3s ease;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomInModal {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager -->
    <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5D2R5C55');
    </script>
    <!-- End Google Tag Manager -->

    <div class="whatsapp-container">
        <div class="header">
            <img src="https://4lifenutrition.site/Assets/brunocelso_pic.webp" alt="Dr. Bruno Celso" class="profile-pic">
            <div class="profile-info">
                <div class="profile-name">Dr. Bruno Celso</div>
                <div class="profile-status">online</div>
            </div>
            <div class="header-icons">
                <div class="header-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15.9 14.3H15L14.7 14C15.4 13.1 15.9 12 15.9 10.7C15.9 7.6 13.4 5.1 10.3 5.1C7.2 5.1 4.7 7.6 4.7 10.7C4.7 13.8 7.2 16.3 10.3 16.3C11.6 16.3 12.7 15.8 13.6 15.1L13.9 15.4V16.3L18.3 20.7L19.7 19.3L15.9 14.3ZM10.3 14.3C8.3 14.3 6.7 12.7 6.7 10.7C6.7 8.7 8.3 7.1 10.3 7.1C12.3 7.1 13.9 8.7 13.9 10.7C13.9 12.7 12.3 14.3 10.3 14.3Z"/>
                    </svg>
                </div>
                <div class="header-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chat-body">
            <!-- Profile section shown initially -->
            <div class="profile-section">
                <div class="profile-section-inner">
                    <img src="https://4lifenutrition.site/Assets/brunocelso_pic.webp" alt="Dr. Bruno Celso" class="large-profile-pic">
                    <h2>Dr. Bruno Celso</h2>
                    <div class="username">drbrunogenuino</div>
                    
                    <!-- Especialidades em Max Plus Col√°geno -->
                    <div class="specialties">
                        <div class="specialty-tag">Especialista</div>
                        <div class="specialty-tag">Anti-idade</div>
                        <div class="specialty-tag">Rejuvenescimento</div>
                        <div class="specialty-tag">Firmeza da Pele</div>
                    </div>
                    
                    <!-- Texto explicativo sobre col√°geno -->
                    <p style="font-size: 14px; color: #444; margin: 10px 0; line-height: 1.4;">
                        Especialista em tratamentos para resultados extraordin√°rios na sua pele.
                    </p>
                    
                    <!-- Bot√£o para iniciar conversa -->
                    <button class="start-conversation" id="start-chat-btn">Iniciar Consulta Online</button>
                    
                    <!-- Texto abaixo do bot√£o -->
                    <div class="cta-text">
                        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 0C3.6 0 0 3.6 0 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm.8 12H7.2v-1.6h1.6V12zM10 8.4c-.5.3-.8.8-.8 1.2H7.6c0-.7.4-1.3.8-1.7.4-.3.8-.6.8-1.1 0-.6-.4-1-1.2-1s-1.2.4-1.2 1H5.2c0-1.4 1.2-2.4 2.8-2.4s2.8 1 2.8 2.4c0 1-.5 1.3-1 1.6z"/>
                        </svg>
                        <span>Tempo m√©dio de resposta: menos de 1 minuto</span>
                    </div>
                    
                    <div class="education">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="#65676B" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-1 17.9c-3.9-.5-7-3.9-7-7.9 0-1.4.4-2.8 1-3.9L7.9 14v2c0 1.1.9 2 2 2h1.1v1.9zm6.5-3c-.3.5-.7.9-1.3 1.2-.5.3-1.1.4-1.7.4-.8 0-1.5-.3-2-.8-.5-.5-.8-1.2-.8-2h2c0 .3.1.5.3.7.2.1.4.2.7.2.2 0 .5-.1.7-.2.2-.1.3-.4.3-.7 0-.3-.1-.5-.4-.7l-1.3-.6c-.5-.2-.9-.5-1.1-.9-.3-.4-.4-.9-.4-1.5 0-.5.2-1 .5-1.4.3-.4.7-.7 1.2-.9.5-.2 1-.3 1.6-.3.8 0 1.4.2 1.9.7.5.4.8 1.1.9 1.8h-2c0-.2-.1-.4-.3-.6-.2-.1-.4-.2-.7-.2-.2 0-.4.1-.6.2-.2.1-.3.4-.3.6 0 .2.1.4.2.5.2.1.4.3.8.4l1.4.6c.4.2.7.5 1 .8.2.4.4.9.4 1.4 0 .6-.2 1.1-.5 1.6zm-3.5-12c4.3.4 7.8 3.9 8 8.3V14h-2v-2c0-1.1-.9-2-2-2h-4v-2l-3.9-4c1-.6 2.2-1 3.9-1.1z"/>
                        </svg>
                        <span>Especialista em Tratamentos</span>
                    </div>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div class="loading">
                <div class="loading-dots">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="loading-text">Conectando com Dr. Bruno...</div>
            </div>
            
            <!-- Chat Container (substitui o TypeBot wrapper) -->
            <div class="chat-container" id="chat-container">
                <div class="messages-container" id="messages-container"></div>
            </div>
            
            <!-- Elemento de √°udio escondido para desbloquear √°udio no iOS -->
            <audio id="audio-unlock" preload="auto" playsinline style="display:none">
                <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjMyLjEwNAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADQgD///////////////////////////////////////////8AAAA8TEFNRTMuMTAwAQAAAAAAAAAAABQIJAi4QQAB4AAADUIoLHtWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" type="audio/mpeg">
            </audio>
        </div>
        
        <div class="footer">
            <div class="input-actions">
                <div class="action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                    </svg>
                </div>
                <div class="action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
            </div>
            <div class="message-input-container">
                <input type="text" class="message-input" id="message-input" placeholder="Escreva aqui">
            </div>
            <div class="send-btn" id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                </svg>
                <span style="margin-left: 5px; font-size: 14px;">Enviar</span>
            </div>
        </div>
    </div>

    <!-- Modal para Imagens -->
    <div id="imageModal" class="image-modal" style="display:none;">
        <span class="image-modal-close" id="imageModalClose">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configura√ß√£o do N8N
            const N8N_CONFIG = {
                baseUrl: 'https://n8n.4lifenutrition.site/webhook',
                endpoints: {
                    process: '/process',
                    duvida: '/responder_duvida',
                    recuperacao: '/recuperacao'
                }
            };
            
            // PIXEL META: Visualiza√ß√£o de Produto - Usu√°rio carregou a p√°gina
            try {
                sendMetaConversionEvent('ViewContent', {}, {
                    content_type: 'product',
                    content_name: 'RENOVAGOLD - P√°gina de Produto',
                    currency: 'EUR',
                    value: 74.98
                });
            } catch (error) {
                console.error('Erro ao enviar pixel ViewContent inicial:', error);
            }

            // Fun√ß√£o para enviar dados para o N8N
            async function sendToN8N(step, additionalData = {}) {
                try {
                    const payload = {
                        Step: step.toString(),
                        session_id: chatData.session_id,
                        fonte: 'whatsapp',
                        nome: chatData.userName || '',
                        telefone: chatData.userPhone || '',
                        problema: chatData.userProblem || '',
                        endereco: chatData.userAddress || '',
                        IA: additionalData.IA || 'False',
                        duvida: additionalData.duvida || '',
                        ...additionalData
                    };

                    console.log('Enviando para N8N:', payload);

                    const response = await fetch(`${N8N_CONFIG.baseUrl}${N8N_CONFIG.endpoints.process}`, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        console.log('Resposta N8N:', data);
                        return data;
                    } else {
                        console.error('Erro N8N:', data);
                        return null;
                    }
                } catch (error) {
                    console.error('Erro ao enviar para N8N:', error);
                    return null;
                }
            }

            // Fun√ß√£o para enviar d√∫vida para N8N
            async function sendQuestionToN8N(question) {
                try {
                    const payload = {
                        Step: chatData.currentStep.toString(),
                        session_id: chatData.session_id,
                        nome: chatData.userName || '',
                        telefone: chatData.userPhone || '',
                        problema: chatData.userProblem || '',
                        duvida: question,
                        IA: 'Duvida',
                        fonte: 'whatsapp'
                    };

                    console.log('Enviando d√∫vida para N8N (Step ' + chatData.currentStep + '):', payload);

                    const response = await fetch(`${N8N_CONFIG.baseUrl}${N8N_CONFIG.endpoints.process}`, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        console.error('Erro HTTP na resposta N8N:', response.status, response.statusText);
                        return null;
                    }

                    const data = await response.json();
                    console.log('Resposta completa do N8N para d√∫vida:', data);
                    
                    // Verificar se h√° resposta da IA
                    if (data && (data.resposta || data.message || (data.message1 && data.message1.texto))) {
                        console.log('IA respondeu com sucesso');
                        return data;
                    } else {
                        console.warn('N8N n√£o retornou resposta da IA v√°lida:', data);
                        return data; // Retornar mesmo assim para debug
                    }
                } catch (error) {
                    console.error('Erro ao enviar d√∫vida para N8N:', error);
                    return null;
                }
            }

            // Elementos da interface
            const profileSection = document.querySelector('.profile-section');
            const chatContainer = document.querySelector('.chat-container');
            const loadingIndicator = document.querySelector('.loading');
            const messageInput = document.querySelector('#message-input');
            const sendButton = document.querySelector('#send-btn');
            const actionButtons = document.querySelectorAll('.action-btn');
            const startChatBtn = document.getElementById('start-chat-btn');
            const messagesContainer = document.querySelector('#messages-container');
            
            // Vari√°vel para o iScroll
            let chatScroll = null;
            
            // Vari√°vel para controlar se novas mensagens devem rolar automaticamente
            let shouldAutoScroll = true;
            let userHasScrolled = false;
            let lastScrollPosition = 0;
            let isScrolling = false;
            
            // Modificar o placeholder do input e o bot√£o de enviar
            if (messageInput) {
                messageInput.placeholder = 'Escreva aqui';
            }
            
            if (sendButton) {
                sendButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path>
                    </svg>
                    <span style="margin-left: 5px; font-size: 14px;">Enviar</span>
                `;
                sendButton.style.width = 'auto';
                sendButton.style.paddingRight = '15px';
                sendButton.style.paddingLeft = '10px';
            }
            
            // Adicionar anima√ß√£o ao bot√£o de iniciar
            if (startChatBtn) {
                setTimeout(() => {
                    startChatBtn.style.animation = 'pulse 2s infinite';
                }, 2000);
                
                // Garantir que o indicador de carregamento esteja centralizado quando vis√≠vel
                // Event listener removido - ser√° adicionado apenas uma vez mais abaixo
            }
            
            // Dados do usu√°rio e da conversa
            const chatData = {
                isChatStarted: false,
                userName: "",
                userPhone: "",
                userProblem: "",
                userQuestions: [],
                conversaIA: [], // Adicionando inicializa√ß√£o do array de conversas com IA
                selectedPackage: "",
                currentStep: 0,
                address: "",
                waitingForUserInput: false,
                fullAddress: "",
                formStep: 0,
                session_id: "",
                origem: "whatsapp",
                experimentID: "v2-main-n8n", // Identificador √∫nico de vers√£o: "v1-main" ou "v2-experimental"
                fallbackMode: false, // Controle do modo fallback
                discountApplied: false, // Controle se desconto foi aplicado
                fallbackQuestion: "" // Armazenar a pergunta do fallback
            };
            
            // Constantes para delays entre mensagens
            const MESSAGE_DELAYS = {
                AUDIO_LONG: 30000,    // 30 segundos para √°udios > 60s
                AUDIO_SHORT: 15000,   // 15 segundos para √°udios < 30s
                TEXT_SHORT: 3000,     // 3 segundos para textos curtos
                TEXT_LONG: 12000,     // 12 segundos para textos longos
                IMAGE: 2000,          // 2 segundos para imagens
                YOUTUBE: 5000,        // 5 segundos para v√≠deos do YouTube
                DEFAULT: 2000         // Delay padr√£o
            };

             /**
             * Normaliza uma URL, removendo caracteres indesejados e garantindo que seja absoluta.
             * @param {string} url - A URL a ser normalizada.
             * @returns {string} A URL normalizada.
             */
            function normalizeUrl(url) {
                if (!url || typeof url !== 'string') {
                    return '';
                }
                // Remove colchetes e aspas que podem vir do N8N
                let cleanedUrl = url.replace(/^\["|"\]$/g, '').replace(/^"|"$/g, '').replace(/^\[|\]$/g, '');

                try {
                    // Tenta criar um objeto URL para verificar se j√° √© absoluta
                    new URL(cleanedUrl);
                    return cleanedUrl; // J√° √© uma URL absoluta e v√°lida
                } catch (_) {
                    // Se falhar, √© uma URL relativa. Vamos torn√°-la absoluta.
                    // Assumindo que os assets relativos est√£o em 'https://suplements.tech/Assets/'
                    const BASE_ASSET_URL = 'https://4lifenutrition.site/Assets/';
                    return new URL(cleanedUrl, BASE_ASSET_URL).href;
                }
            }

             /**
             * Calcula o delay apropriado baseado no tipo e conte√∫do da mensagem
             * @param {Object} message - Objeto da mensagem
             * @param {Object} nextMessage - Pr√≥xima mensagem (opcional)
             * @returns {number} Delay em milissegundos
             */
            async function getMessageDelay(message, nextMessage = null) {
                if (!message) return MESSAGE_DELAYS.DEFAULT;

                switch (message.type) {
                    case 'audio':
                        // Tentar obter a dura√ß√£o do √°udio
                        try {
                            const audio = new Audio(message.audioUrl);
                            await new Promise((resolve, reject) => {
                                audio.addEventListener('loadedmetadata', () => {
                                    resolve(audio.duration);
                                });
                                audio.addEventListener('error', reject);
                                // Timeout de 5 segundos para carregar metadata
                                setTimeout(reject, 5000);
                            });
                            
                            return audio.duration > 60 ? MESSAGE_DELAYS.AUDIO_LONG : MESSAGE_DELAYS.AUDIO_SHORT;
                        } catch (error) {
                            console.warn('N√£o foi poss√≠vel determinar dura√ß√£o do √°udio:', error);
                            return MESSAGE_DELAYS.AUDIO_SHORT;
                        }
                        
                    case 'text':
                        // Verificar se √© texto curto ou longo
                        const isLongText = message.content.length > 100 || 
                                         message.content.split('\n').length > 2;
                        return isLongText ? MESSAGE_DELAYS.TEXT_LONG : MESSAGE_DELAYS.TEXT_SHORT;
                        
                    case 'image':
                        return MESSAGE_DELAYS.IMAGE;
                        
                    case 'youtube':
                        return MESSAGE_DELAYS.YOUTUBE;
                        
                    default:
                        return MESSAGE_DELAYS.DEFAULT;
                }
            }
            
            // Fun√ß√£o para desbloquear √°udio no iOS
            function unlockAudioForIOS() {
                return new Promise((resolve) => {
                    const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
                    
                    if (!isIOS) {
                        return resolve(); // N√£o √© iOS, n√£o precisa desbloquear
                    }
                    
                    const unlockElement = document.getElementById('audio-unlock');
                    
                    if (!unlockElement) {
                        return resolve(); // Elemento n√£o encontrado
                    }
                    
                    // For√ßa o carregamento
                    unlockElement.load();
                    
                    // Tenta reproduzir
                    const playPromise = unlockElement.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            // Desbloqueado com sucesso
                            unlockElement.pause();
                            unlockElement.currentTime = 0;
                            resolve();
                        }).catch(() => {
                            // Falhou no desbloqueio autom√°tico, vamos deixar para o evento de toque
                            resolve();
                        });
                    } else {
                        resolve();
                    }
                });
            }
            
            // Atualizar a fun√ß√£o para usar as novas caracter√≠sticas visuais
            function createCustomAudioPlayer(audioUrl, isReply = false, isUser = false) {
                const playerContainer = document.createElement('div');
                playerContainer.className = 'whatsapp-audio-player';
                
                if (isReply) {
                    playerContainer.classList.add('audio-reply-player');
                }
                
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                
                // Gerar alturas aleat√≥rias para cada barra para dar aspecto realista
                const barHeights = [];
                
                // Verificar se √© um dispositivo m√≥vel para adaptar o n√∫mero de barras
                const isMobile = window.innerWidth <= 480;
                const barsCount = isMobile ? (isReply ? 20 : 24) : (isReply ? 30 : 40); // Menos barras para resposta
                
                for (let i = 0; i < barsCount; i++) {
                    let height;
                    if (i < barsCount * 0.15 || i > barsCount * 0.85) {
                        // Barras mais baixas no in√≠cio e fim (15% do total)
                        height = 20 + Math.random() * 25;
                    } else if (
                        (i > barsCount * 0.3 && i < barsCount * 0.4) || 
                        (i > barsCount * 0.6 && i < barsCount * 0.7)
                    ) {
                        // Barras mais altas em dois pontos (entre 30-40% e 60-70%)
                        height = 60 + Math.random() * 35;
                    } else {
                        // Barras de altura m√©dia no restante
                        height = 30 + Math.random() * 45;
                    }
                    barHeights.push(Math.floor(height));
                }
                
                const waveformDiv = document.createElement('div');
                waveformDiv.className = 'waveform';
                for (let i = 0; i < barHeights.length; i++) {
                    const bar = document.createElement('span');
                    bar.style.height = barHeights[i] + '%';
                    // Se for resposta, as barras t√™m tamanho especial
                    if (isReply) {
                        // Altura aumentada para maior visibilidade
                        bar.style.height = (barHeights[i] * 0.9) + '%';
                        bar.style.minWidth = '2px';
                        bar.style.maxWidth = '3px';
                        bar.style.margin = '0 1px';
                        // Cor mais escura para melhor contraste
                        bar.style.backgroundColor = 'rgba(0, 0, 0, 0.18)';
                    }
                    waveformDiv.appendChild(bar);
                }
                
                // Adicionar avatar do Dr. Bruno no player de √°udio (agora no final do waveform)
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                avatarDiv.style.width = '40px';
                avatarDiv.style.height = '40px';
                avatarDiv.style.borderRadius = '50%';
                avatarDiv.style.overflow = 'hidden';
                avatarDiv.style.marginLeft = '8px';
                avatarDiv.style.flexShrink = '0';
                avatarDiv.innerHTML = `<img src="https://4lifenutrition.site/Assets/brunocelso_pic.webp" alt="Dr. Bruno Celso" style="width: 100%; height: 100%; object-fit: cover;">`;
                
                playerContainer.appendChild(playButton);
                // Remover a barra de progresso separada e usar apenas o waveform
                playerContainer.appendChild(waveformDiv);
                
                // N√£o adicionar o avatar se for um √°udio de resposta para evitar redund√¢ncia
                if (!isReply) {
                    playerContainer.appendChild(avatarDiv);
                } else {
                    // Para √°udios de resposta, adicionamos um avatar maior no final da waveform
                    const replyAvatarDiv = document.createElement('div');
                    replyAvatarDiv.className = 'message-avatar reply-avatar';
                    replyAvatarDiv.style.width = '35px';
                    replyAvatarDiv.style.height = '35px';
                    replyAvatarDiv.style.borderRadius = '50%';
                    replyAvatarDiv.style.overflow = 'hidden';
                    replyAvatarDiv.style.marginLeft = '6px';
                    replyAvatarDiv.style.marginRight = '2px';
                    replyAvatarDiv.style.flexShrink = '0';
                    replyAvatarDiv.style.alignSelf = 'center';
                    replyAvatarDiv.innerHTML = `<img src="https://4lifenutrition.site/Assets/brunocelso_pic.webp" alt="Dr. Bruno Celso" style="width: 100%; height: 100%; object-fit: cover;">`;
                    playerContainer.appendChild(replyAvatarDiv);
                    
                    // Adicionar timestamp para mensagens recebidas em √°udios com resposta
                    const messageTimeContainer = document.createElement('div');
                    messageTimeContainer.className = 'message-time-container';
                    messageTimeContainer.innerHTML = `
                        <span class="message-time">${getCurrentTime()}</span>
                        ${isUser ? '<span class="message-status">‚úì‚úì</span>' : ''}
                    `;
                    playerContainer.appendChild(messageTimeContainer);
                }
                
                // Criar um elemento de √°udio real para ser usado pelo player
                const audioElement = document.createElement('audio');
                audioElement.style.display = 'none';
                audioElement.setAttribute('playsinline', '');
                audioElement.setAttribute('webkit-playsinline', '');
                audioElement.preload = 'metadata';
                
                // Adicionar fonte de √°udio
                const mp3Source = document.createElement('source');
                mp3Source.src = normalizeUrl(audioUrl); // CORRE√á√ÉO: Normaliza a URL do √°udio
                mp3Source.type = 'audio/mpeg';
                audioElement.appendChild(mp3Source);
                
                // Adicionar o elemento de √°udio ao DOM
                document.body.appendChild(audioElement);
                
                let isPlaying = false;
                
                function updatePlayButton() {
                    if (isPlaying) {
                        playButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                    } else {
                        playButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                    }
                }
                
                audioElement.addEventListener('timeupdate', function() {
                    if (audioElement.duration) {
                        const percent = (audioElement.currentTime / audioElement.duration) * 100;
                        // Atualizar a visualiza√ß√£o do progresso atrav√©s das barras do waveform
                        const barCount = waveformDiv.children.length;
                        const activeBarCount = Math.floor((audioElement.currentTime / audioElement.duration) * barCount);
                        for (let i = 0; i < barCount; i++) {
                            if (i < activeBarCount) {
                                if (isReply) {
                                    waveformDiv.children[i].classList.add('active');
                                } else {
                                    waveformDiv.children[i].style.backgroundColor = '#00a884';
                                }
                            } else {
                                if (isReply) {
                                    waveformDiv.children[i].classList.remove('active');
                                } else {
                                    waveformDiv.children[i].style.backgroundColor = '';
                                }
                            }
                        }
                        // Atualizar o tempo no audioTimeDisplay do player
                        const minutes = Math.floor(audioElement.currentTime / 60);
                        const seconds = Math.floor(audioElement.currentTime % 60);
                        const timeText = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                        
                        // Encontrar o audioTimeDisplay no player
                        const audioTimeDisplays = playerContainer.querySelectorAll('.time');
                        if (audioTimeDisplays.length > 0) {
                            audioTimeDisplays[0].textContent = timeText;
                        }
                    }
                });
                
                audioElement.addEventListener('ended', function() {
                    isPlaying = false;
                    updatePlayButton();
                    Array.from(waveformDiv.children).forEach(bar => {
                        if (isReply) {
                            bar.classList.remove('active');
                        } else {
                            bar.style.backgroundColor = '';
                        }
                    });
                });
                
                audioElement.addEventListener('loadedmetadata', function() {
                    const minutes = Math.floor(audioElement.duration / 60);
                    const seconds = Math.floor(audioElement.duration % 60);
                    const timeText = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    
                    // Encontrar o audioTimeDisplay no player
                    const audioTimeDisplays = playerContainer.querySelectorAll('.time');
                    if (audioTimeDisplays.length > 0) {
                        audioTimeDisplays[0].textContent = timeText;
                    }
                });
                
                // bot√£o play/pause personalizado integrado com o player
                audioElement.addEventListener('play', function() {
                    isPlaying = true;
                    updatePlayButton();
                });
                
                audioElement.addEventListener('pause', function() {
                    isPlaying = false;
                    updatePlayButton();
                });
                
                // For√ßa atualiza√ß√µes de UI quando o √°udio termina, pausa ou ocorre erro
                audioElement.addEventListener('ended', function() {
                    isPlaying = false;
                    updatePlayButton();
                });
                
                audioElement.addEventListener('error', function() {
                    isPlaying = false;
                    updatePlayButton();
                    console.error('Erro ao reproduzir √°udio:', audioElement.error);
                });
                
                // Melhoria para lidar com intera√ß√£o em dispositivos m√≥veis
                const handlePlayButtonInteraction = function(e) {
                    e.stopPropagation(); // Prevenir propaga√ß√£o do evento
                    e.preventDefault(); // Prevenir comportamento padr√£o
                    
                    unlockAudioForIOS().then(() => {
                        // Parar todos os outros √°udios tocando
                        document.querySelectorAll('audio').forEach(audio => {
                            if (audio !== audioElement && !audio.paused) {
                                audio.pause();
                            }
                        });
                        
                        if (isPlaying) {
                            audioElement.pause();
                        } else {
                            // Reproduzir com abordagem compat√≠vel com dispositivos m√≥veis
                            const playPromise = audioElement.play();
                            
                            if (playPromise !== undefined) {
                                playPromise
                                    .then(() => {
                                        // Reprodu√ß√£o iniciada com sucesso
                                        isPlaying = true;
                                        updatePlayButton();
                                    })
                                    .catch(error => {
                                        // Erro na reprodu√ß√£o - geralmente ocorre por intera√ß√£o do usu√°rio ser necess√°ria
                                        console.error('Erro ao reproduzir √°udio:', error);
                                        isPlaying = false;
                                        updatePlayButton();
                                        
                                        // Tentar novamente com intera√ß√£o expl√≠cita
                                        const unlockAudio = function() {
                                            document.removeEventListener('click', unlockAudio);
                                            document.removeEventListener('touchstart', unlockAudio);
                                            audioElement.play()
                                                .then(() => {
                                                    isPlaying = true;
                                                    updatePlayButton();
                                                })
                                                .catch(err => console.error('Segundo erro ao reproduzir:', err));
                                        };
                                        
                                        document.addEventListener('click', unlockAudio, {once: true});
                                        document.addEventListener('touchstart', unlockAudio, {once: true});
                                    });
                            }
                        }
                        updatePlayButton();
                    });
                };
                
                // Adicionar eventos para click e touch
                playButton.addEventListener('click', handlePlayButtonInteraction);
                playButton.addEventListener('touchstart', handlePlayButtonInteraction, {passive: false});
                
                // Adicionar evento de clique e touch ao waveform para controlar a posi√ß√£o de reprodu√ß√£o
                const handleWaveformInteraction = function(e) {
                    e.stopPropagation(); // Prevenir propaga√ß√£o do evento
                    e.preventDefault(); // Prevenir comportamento padr√£o
                    
                    if (audioElement.duration) {
                        const rect = waveformDiv.getBoundingClientRect();
                        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
                        const pos = (clientX - rect.left) / rect.width;
                        audioElement.currentTime = pos * audioElement.duration;
                        
                        // Se estiver pausado, iniciar a reprodu√ß√£o ao clicar no waveform
                        if (!isPlaying) {
                            audioElement.play()
                                .then(() => {
                                    isPlaying = true;
                                    updatePlayButton();
                                })
                                .catch(error => console.error('Erro ao reproduzir ap√≥s seekbar:', error));
                        }
                    }
                };
                
                waveformDiv.addEventListener('click', handleWaveformInteraction);
                waveformDiv.addEventListener('touchstart', handleWaveformInteraction, {passive: false});
                
                // Adicionar o timeDisplay ao player de √°udio
                const audioTimeDisplay = document.createElement('div');
                audioTimeDisplay.className = 'time';
                if (isReply) {
                    audioTimeDisplay.classList.add('reply-time');
                    audioTimeDisplay.style.position = 'absolute';
                    audioTimeDisplay.style.right = '0px';
                    audioTimeDisplay.style.bottom = '2px';
                    audioTimeDisplay.style.margin = '0';
                    audioTimeDisplay.style.fontSize = '10px';
                } else {
                    audioTimeDisplay.style.position = 'absolute';
                    audioTimeDisplay.style.right = '8px';
                    audioTimeDisplay.style.bottom = '0px';
                }
                audioTimeDisplay.textContent = '0:00';
                playerContainer.appendChild(audioTimeDisplay);
                
                return playerContainer;
            }
            
            // Formatar hor√°rio atual
            function getCurrentTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            // Converter texto simples para HTML com suporte b√°sico a Markdown
            function convertMarkdownToHtml(text) {
                if (!text) return '';
                
                // Negrito (** ou __)
                text = text.replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>');
                
                // It√°lico (* ou _)
                text = text.replace(/(\*|_)(.*?)\1/g, '<em>$2</em>');
                
                // Links [texto](url)
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                // Listas n√£o ordenadas
                text = text.replace(/^\s*[\-\*]\s+(.*?)$/gm, '<li>$1</li>');
                text = text.replace(/<li>(.*?)<\/li>(\n<li>.*?<\/li>)+/g, '<ul>$&</ul>');
                
                // Quebras de linha
                text = text.replace(/\n/g, '<br>');
                
                return text;
            }

            // Criar elemento de mensagem
            function createMessageElement(message, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isUser ? 'message-out' : 'message-in'}`;
                
                // Adicionar uma pequena anima√ß√£o de atraso para simular o efeito de digita√ß√£o
                messageDiv.style.animationDelay = '0.2s';
                
                // Conte√∫do da mensagem
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Adicionar componente de resposta se houver
                if (message.replyTo) {
                    const replyContainer = document.createElement('div');
                    replyContainer.className = 'reply-container';
                    
                    const replyWrapper = document.createElement('div');
                    replyWrapper.className = 'reply-wrapper';
                    
                    const replyTextContainer = document.createElement('div');
                    replyTextContainer.className = 'reply-text-container';
                    
                    const replySender = document.createElement('div');
                    replySender.className = 'reply-sender';
                    replySender.textContent = message.replyTo.sender || 'Dr. Bruno Celso';
                    replyTextContainer.appendChild(replySender);
                    
                    const replyContent = document.createElement('div');
                    replyContent.className = 'reply-content';
                    
                    // Se a mensagem de resposta cont√©m texto
                    if (message.replyTo.text) {
                        replyContent.textContent = message.replyTo.text;
                    } else if (message.replyTo.type === 'image') {
                        replyContent.textContent = 'Foto';
                    } else if (message.replyTo.type === 'audio') {
                        replyContent.textContent = '√Åudio';
                    }
                    
                    replyTextContainer.appendChild(replyContent);
                    replyWrapper.appendChild(replyTextContainer);
                    
                    // Se a mensagem de resposta cont√©m uma imagem
                    if (message.replyTo.imageUrl) {
                        const replyImage = document.createElement('img');
                        replyImage.className = 'reply-image';
                        replyImage.src = message.replyTo.imageUrl;
                        replyImage.alt = 'Imagem de resposta';
                        replyWrapper.appendChild(replyImage);
                    }
                    
                    replyContainer.appendChild(replyWrapper);
                    contentDiv.appendChild(replyContainer);
                }
                
                if (message.type === 'text') {
                    // Converter texto para HTML com suporte a Markdown
                    const content = convertMarkdownToHtml(message.content);
                    
                    contentDiv.innerHTML += `
                        <div class="message-text">${content}</div>
                        <span class="message-time">${getCurrentTime()}</span>
                        ${isUser ? '<span class="message-status">‚úì‚úì</span>' : ''}
                    `;
                    messageDiv.appendChild(contentDiv);
                } else if (message.type === 'image') {
                    // Criar container para a imagem para adicionar o √≠cone de zoom
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'message-image-container';
                    
                    // Criar a imagem com atributos para visualiza√ß√£o ampliada
                    const img = document.createElement('img');
                    img.src = normalizeUrl(message.imageUrl); // CORRE√á√ÉO: Normaliza a URL da imagem
                    img.alt = "Imagem";
                    img.className = "message-image";
                    img.dataset.fullsize = normalizeUrl(message.imageUrl); // CORRE√á√ÉO: Normaliza a URL da imagem
                    
                    // Adicionar √≠cone de zoom
                    const zoomIcon = document.createElement('div');
                    zoomIcon.className = 'zoom-icon';
                    zoomIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="white"><path d="M15.7 14.3l-4-4c.8-1.1 1.3-2.5 1.3-4 0-3.9-3.1-7-7-7s-7 3.1-7 7 3.1 7 7 7c1.5 0 2.9-.5 4-1.3l4 4c.2.2.4.3.7.3s.5-.1.7-.3c.4-.4.4-1 0-1.4zm-13.7-8.3c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5-5-2.2-5-5z"/><path d="M8 5h-2v2h-2v2h2v2h2v-2h2v-2h-2z"/></svg>';
                    
                    // Adicionar a imagem e o √≠cone ao container
                    imageContainer.appendChild(img);
                    imageContainer.appendChild(zoomIcon);
                    
                    // Adicionar texto (se houver) e o container de imagem
                    contentDiv.innerHTML += message.text ? `<div class="message-text">${message.text}</div>` : '';
                    contentDiv.appendChild(imageContainer);
                    
                    // Adicionar hora e status
                    const timeElement = document.createElement('span');
                    timeElement.className = 'message-time';
                    timeElement.textContent = getCurrentTime();
                    contentDiv.appendChild(timeElement);
                    
                    if (isUser) {
                        const statusElement = document.createElement('span');
                        statusElement.className = 'message-status';
                        statusElement.textContent = '‚úì‚úì';
                        contentDiv.appendChild(statusElement);
                    }
                    
                    messageDiv.appendChild(contentDiv);
                    
                    // Adicionar evento de clique para abrir em tamanho maior
                    imageContainer.addEventListener('click', function() {
                        openImageModal(normalizeUrl(message.imageUrl)); // CORRE√á√ÉO: Normaliza a URL da imagem
                    });
                } else if (message.type === 'audio') {
                    if (message.replyTo) {
                        // O componente de resposta j√° foi adicionado acima
                        // Para o √°udio, vamos criar o player dentro do contentDiv
                        const audioPlayer = createCustomAudioPlayer(message.audioUrl, true, isUser);
                        contentDiv.appendChild(audioPlayer);
                        
                        // N√£o adicionar o timestamp aqui, ele j√° √© adicionado no pr√≥prio player
                        // Removemos o bloco de c√≥digo que adiciona o timeContainer
                        
                        messageDiv.appendChild(contentDiv);
                    } else {
                        // Para √°udio sem resposta, mantemos o comportamento original
                        // Criar o player de √°udio com o texto (se houver)
                        const audioPlayer = createCustomAudioPlayer(message.audioUrl, false, isUser);
                        
                        // Precisa de texto? Adicione antes do player
                        if (message.text) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'message-content';
                            textDiv.innerHTML = `
                                <div class="message-text">${message.text}</div>
                                <span class="message-time">${getCurrentTime()}</span>
                                ${isUser ? '<span class="message-status">‚úì‚úì</span>' : ''}
                            `;
                            messageDiv.appendChild(textDiv);
                        }
                        
                        // Adicionar o player de √°udio diretamente ao container da mensagem
                        messageDiv.appendChild(audioPlayer);
                        
                        // Adicionar tempo e status diretamente no player de √°udio
                        const timeContainer = document.createElement('div');
                        timeContainer.className = 'message-time-container';
                        timeContainer.style.position = 'absolute';
                        timeContainer.style.left = '3px';
                        timeContainer.style.bottom = '4px';
                        timeContainer.style.display = 'flex';
                        timeContainer.style.alignItems = 'center';
                        timeContainer.innerHTML = `
                            <span class="message-time" style="margin-right: 2px;">${getCurrentTime()}</span>
                            ${isUser ? '<span class="message-status">‚úì‚úì</span>' : ''}
                        `;
                        audioPlayer.appendChild(timeContainer);
                    }
                } else if (message.type === 'youtube') {
                    contentDiv.innerHTML += `
                        <div class="message-text">${message.text || ''}</div>
                        <iframe width="250" height="140" src="https://www.youtube.com/embed/${message.videoId}?autoplay=1&mute=0" 
                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; 
                        gyroscope; picture-in-picture" allowfullscreen></iframe>
                        <span class="message-time">${getCurrentTime()}</span>
                        ${isUser ? '<span class="message-status">‚úì‚úì</span>' : ''}
                    `;
                    messageDiv.appendChild(contentDiv);
                }
                
                return messageDiv;
            }
            
            // Mostrar indicador de digita√ß√£o
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = '<span></span><span></span><span></span>';
                typingDiv.id = 'typing-indicator';
                messagesContainer.appendChild(typingDiv);
                scrollToBottom();
            }
            
            // Remover indicador de digita√ß√£o
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // Adicionar mensagem ao chat
            async function addMessage(message, isUser = false) {
                const messageElement = createMessageElement(message, isUser);
                messagesContainer.appendChild(messageElement);
                
                // Ajustar explicitamente as margens dos timestamps ap√≥s adicionar ao DOM
                setTimeout(() => {
                    const replyContainers = messageElement.querySelectorAll('.reply-container');
                    const timeElements = messageElement.querySelectorAll('.message-time');
                    
                    timeElements.forEach(el => {
                        // Verificar se este elemento de tempo est√° dentro ou ap√≥s um cont√™iner de resposta
                        const isInReplyContainer = el.closest('.reply-container') !== null;
                        const hasReplyContainerSibling = el.parentElement && 
                                                        el.parentElement.querySelector('.reply-container') !== null;
                        
                        if (isInReplyContainer || hasReplyContainerSibling || replyContainers.length > 0) {
                            el.style.marginBottom = '0px';
                            el.style.marginLeft = '-8px';
                        } else {
                            el.style.marginBottom = '-4px';
                        }
                    });
                }, 0);
                
                // Calcular o delay apropriado para esta mensagem
                const delay = await getMessageDelay(message);
                
                // Atualizar o iScroll e rolar para o fim
                setTimeout(function() {
                    // Verificar se h√° imagens na mensagem e esperar que carreguem
                    const images = messageElement.querySelectorAll('img');
                    if (images.length > 0) {
                        // Se houver imagens, esperar pelo carregamento antes de atualizar
                        let loadedImages = 0;
                        images.forEach(img => {
                            if (img.complete) {
                                loadedImages++;
                            } else {
                                img.onload = function() {
                                    loadedImages++;
                                    if (loadedImages === images.length) {
                                        refreshScrollAndCheckContent();
                                    }
                                };
                                img.onerror = function() {
                                    loadedImages++;
                                    if (loadedImages === images.length) {
                                        refreshScrollAndCheckContent();
                                    }
                                };
                            }
                        });
                        
                        if (loadedImages === images.length) {
                            refreshScrollAndCheckContent();
                        }
                    } else {
                        // Se n√£o houver imagens, atualizar diretamente
                        refreshScrollAndCheckContent();
                    }
                    
                    function refreshScrollAndCheckContent() {
                        // Verificar a altura real do conte√∫do
                        const containerHeight = chatContainer.clientHeight;
                        const contentHeight = messagesContainer.offsetHeight;
                        
                        // Apenas atualizar e rolar se houver conte√∫do suficiente
                        if (contentHeight > containerHeight) {
                            if (chatScroll) {
                                chatScroll.refresh();
                                
                                // Verificar se deve rolar para o fim
                                const isNearBottom = chatScroll ? 
                                    (chatScroll.y > chatScroll.maxScrollY - 150) : true;
                                
                                if ((isUser || isNearBottom) && shouldAutoScroll) {
                                    // Usar um valor negativo para garantir que n√£o haja espa√ßo em branco no final
                                    chatScroll.scrollTo(0, chatScroll.maxScrollY, 300);
                                }
                            }
                        }
                    }
                }, 100);
                
                // Retornar o delay calculado para que a fun√ß√£o chamadora possa aguardar
                return delay;
            }
            
            // Modificar a fun√ß√£o scrollToBottom para ser mais inteligente
            function scrollToBottom(force = false) {
                if (chatScroll) {
                    // Apenas rolar se tiver conte√∫do suficiente para justificar rolagem
                    const containerHeight = chatContainer.clientHeight;
                    const contentHeight = messagesContainer.offsetHeight;
                    
                    // N√£o rolar se n√£o houver conte√∫do suficiente
                    if (contentHeight <= containerHeight) {
                        return;
                    }
                    
                    // Se force for verdadeiro ou shouldAutoScroll for verdadeiro
                    if (force || shouldAutoScroll) {
                        setTimeout(function() {
                            chatScroll.refresh();
                            // Evita rolar al√©m do poss√≠vel
                            if (chatScroll.maxScrollY < 0) {
                                chatScroll.scrollTo(0, chatScroll.maxScrollY, 300);
                            }
                        }, 100);
                    }
                }
            }
            
            // Extrair ID do YouTube de uma URL
            function getYoutubeVideoId(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }
            
            // Processar entrada do usu√°rio via N8N
            async function processUserInput(userInput) {
                if (!userInput.trim()) return;
                
                // Adicionar mensagem do usu√°rio ao chat
                addMessage({ type: 'text', content: userInput }, true);
                
                // Limpar campo de entrada
                messageInput.value = '';
                
                // Verificar se est√° no modo fallback
                if (chatData.fallbackMode) {
                    await processFallbackInput(userInput);
                    return;
                }
                
                // Atualizar dados do usu√°rio baseado no step atual
                switch (chatData.currentStep) {
                    case 0:
                        // Temporariamente armazenar o input para verificar se deve repetir
                        chatData.tempUserName = userInput;
                        chatData.currentStep = 1;
                        break;
                    case 1:
                        // Temporariamente armazenar o input para verificar se deve repetir
                        chatData.tempUserPhone = userInput;
                        chatData.currentStep = 2;
                        break;
                    case 2:
                        chatData.userProblem = userInput;
                        chatData.currentStep = 3;
                        break;
                    case 3:
                        // Etapa 3: Recebe qualquer input e prossegue para etapa 4
                        chatData.currentStep = 4;
                        break;
                    case 4:
                        // Etapa 4: Prossegue direto para etapa 5
                        chatData.currentStep = 5;
                        break;
                    case 5:
                        // Etapa 5: Verificar se resposta √© positiva ou negativa
                        await processStep5Response(userInput);
                        return; // N√£o continuar processamento normal
                    case 6:
                        await processQuestions(userInput);
                        return; // N√£o continuar processamento normal
                    case 7:
                        await processPostSaleQuestions(userInput);
                        return; // N√£o continuar processamento normal
                }
                
                // Enviar dados atualizados para N8N
                showTypingIndicator(); // Mostrar indicador de digita√ß√£o
                const n8nResponse = await sendToN8N(chatData.currentStep.toString(), {
                    nome: chatData.userName || chatData.tempUserName || '',
                    telefone: chatData.userPhone || chatData.tempUserPhone || '',
                    problema: chatData.userProblem
                });
                hideTypingIndicator(); // Remover indicador de digita√ß√£o
                
                if (n8nResponse) {
                    // Processar resposta do N8N
                    await processN8NResponse(n8nResponse);
                } else {
                    // N8N gerencia as mensagens - n√£o mostrar fallback
                    console.log('N8N n√£o respondeu para step:', chatData.currentStep);
                }
                
                // Verificar se √© etapa 4 para prosseguir automaticamente
                if (chatData.currentStep === 4) {
                    // Etapa 4: Prosseguir automaticamente para etapa 5
                    setTimeout(async () => {
                        chatData.currentStep = 5;
                        
                        // Mostrar indicador de digita√ß√£o antes de enviar step 5
                        showTypingIndicator();
                        
                        // Enviar step 5 para N8N
                        const n8nResponse5 = await sendToN8N('5', {
                            nome: chatData.userName,
                            telefone: chatData.userPhone,
                            problema: chatData.userProblem
                        });
                        
                        // Remover indicador de digita√ß√£o
                        hideTypingIndicator();
                        
                        if (n8nResponse5) {
                            await processN8NResponse(n8nResponse5);
                        }
                        
                        waitForUserInput();
                    }, 2000); // Aguardar 2 segundos antes de prosseguir
                } else {
                    waitForUserInput();
                }
            }
            
            // Iniciar o chat
            async function startChat() {
                // Verificar se o chat j√° foi iniciado para evitar duplica√ß√£o
                if (chatData.isChatStarted) return;
                
                chatData.isChatStarted = true;
                
                // PIXEL META: InitiateCheckout - Lead iniciou o chat (m√©trica de convers√£o precisa)
                try {
                    await sendMetaConversionEvent('InitiateCheckout', {
                        country: 'Portugal'
                    }, {
                        content_type: 'chat_interaction',
                        content_name: 'WhatsApp Lead Entrou no Chat',
                        currency: 'EUR',
                        value: 74.98,
                        source: 'whatsapp_chat'
                    });
                    console.log('‚úÖ InitiateCheckout enviado - Lead entrou no chat');
                } catch (error) {
                    console.error('‚ùå Erro ao enviar pixel InitiateCheckout:', error);
                }
                
                // Gerar um ID de sess√£o √∫nico
                chatData.session_id = 'ws_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Iniciar o pedido no N8N
                try {
                    const n8nResponse = await sendToN8N('0', {
                        origem: chatData.origem,
                        versao: chatData.experimentID
                    });
                    
                    if (n8nResponse) {
                        console.log('Sess√£o iniciada no N8N com sucesso:', chatData.session_id);
                    } else {
                        console.error('Erro ao iniciar sess√£o no N8N');
                    }
                } catch (error) {
                    console.error('Erro ao iniciar sess√£o no N8N:', error);
                }
                
                // Animar a sa√≠da do perfil
                profileSection.style.animation = 'fadeOutProfile 0.5s ease-out forwards';
                
                // Ap√≥s a anima√ß√£o de sa√≠da do perfil, mostrar o indicador de carregamento
                setTimeout(() => {
                    // Esconder o perfil
                    profileSection.style.display = 'none';
                    
                    // Preparar e mostrar indicador de carregamento com anima√ß√£o
                    loadingIndicator.style.opacity = '0';
                    loadingIndicator.style.filter = 'blur(3px)';
                    loadingIndicator.style.display = 'flex';
                    
                    // Animar a entrada do indicador de carregamento
                    setTimeout(() => {
                        loadingIndicator.style.opacity = '1';
                        loadingIndicator.style.filter = 'blur(0)';
                    }, 50);
                }, 400);
                
                // Aguardar um tempo reduzido para carregamento mais r√°pido
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Animar a sa√≠da do indicador de carregamento
                loadingIndicator.style.opacity = '0';
                loadingIndicator.style.filter = 'blur(3px)';
                
                // Ap√≥s a anima√ß√£o de sa√≠da, esconder o indicador e mostrar o chat
                setTimeout(() => {
                    // Esconder indicador de carregamento
                    loadingIndicator.style.display = 'none';
                    
                    // Preparar o container do chat para anima√ß√£o
                    chatContainer.style.display = 'block';
                    chatContainer.style.opacity = '0';
                    chatContainer.style.transform = 'translateY(20px)';
                    
                    // Animar a entrada do container do chat
                    setTimeout(() => {
                        chatContainer.style.transition = 'all 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
                        chatContainer.style.opacity = '1';
                        chatContainer.style.transform = 'translateY(0)';
                    }, 50);
                }, 500);
                
                // Definir estilos de rolagem - corrigido para evitar barras duplas
                chatContainer.style.overflowY = 'hidden';
                chatContainer.style.WebkitOverflowScrolling = 'touch';
                
                // Habilitar o campo de entrada
                messageInput.removeAttribute('readonly');
                
                // Desbloquear √°udio para iOS
                unlockAudioForIOS();
                
                // Iniciar fluxo N8N
                initializeN8NFlow();
                
                // Inicializar o iScroll para rolagem suave
                initScrolling();
                
                // Criar bot√£o de rolagem para o fim
                createScrollToBottomButton();
                
                // Adicionar classe para melhorar a rolagem em dispositivos m√≥veis
                document.body.classList.add('chat-started');
                
                // For√ßa uma atualiza√ß√£o da rolagem ap√≥s o chat iniciar
                setTimeout(function() {
                    if (chatScroll) {
                        chatScroll.refresh();
                        scrollToBottom(true);
                    }
                }, 500);
            }
            
            // Inicializar iScroll para rolagem suave
            function initScrolling() {
                // Certificar-se de que o container est√° vis√≠vel
                if (!chatContainer) return;
                
                // Destruir inst√¢ncia anterior se existir
                if (chatScroll) {
                    chatScroll.destroy();
                    chatScroll = null;
                }
                
                // Configurar o iScroll com op√ß√µes otimizadas para dispositivos m√≥veis
                chatScroll = new IScroll(chatContainer, {
                    scrollbars: true,
                    mouseWheel: true,
                    interactiveScrollbars: true,
                    shrinkScrollbars: 'scale',
                    fadeScrollbars: true,
                    click: true,
                    tap: true,
                    useTransition: true,
                    useTransform: true,
                    probeType: 3,
                    momentum: true,
                    bounce: false, // Desativar o efeito de "bounce" que pode causar rolagem em √°rea vazia
                    deceleration: 0.001, // Reduzir a velocidade de desacelera√ß√£o para evitar rolar demais
                    // Adicionadas op√ß√µes para melhorar a rolagem
                    preventDefaultException: { tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT|A|IMG)$/ },
                    disablePointer: true,
                    disableTouch: false,
                    disableMouse: false
                });
                
                // Detectar quando o usu√°rio rola manualmente
                chatScroll.on('scrollStart', function() {
                    userHasScrolled = true;
                    
                    // Verificar se h√° algum conte√∫do
                    if (messagesContainer.offsetHeight <= chatContainer.clientHeight) {
                        // Se n√£o houver conte√∫do suficiente, cancelar rolagem
                        this.enabled = false;
                        // Reativar ap√≥s um pequeno delay
                        setTimeout(() => { this.enabled = true; }, 100);
                    }
                });
                
                // Corrigir o problema de rolagem para o nada
                chatScroll.on('scrollEnd', function() {
                    // Se o conte√∫do for menor que o container, n√£o permitir rolagem
                    if (messagesContainer.offsetHeight <= chatContainer.clientHeight) {
                        return;
                    }
                    
                    // Verificar se o usu√°rio est√° pr√≥ximo do fim
                    const isNearBottom = this.y > this.maxScrollY - 50;
                    
                    // Se estiver pr√≥ximo do fim, permitir rolagem autom√°tica
                    if (isNearBottom) {
                        shouldAutoScroll = true;
                    } else {
                        shouldAutoScroll = false;
                    }
                    
                    // Verificar se a rolagem est√° al√©m do limite permitido
                    if (this.y < this.maxScrollY) {
                        // Voltar para o limite m√°ximo de rolagem
                        this.scrollTo(0, this.maxScrollY, 300);
                    } else if (this.y > 0) {
                        // Voltar para o topo se rolar al√©m do in√≠cio
                        this.scrollTo(0, 0, 300);
                    }
                });
                
                // Atualizar o iScroll quando o layout mudar
                window.addEventListener('resize', function() {
                    if (chatScroll) {
                        setTimeout(function() {
                            chatScroll.refresh();
                            
                            // Verificar altura do conte√∫do
                            const containerHeight = chatContainer.clientHeight;
                            const contentHeight = messagesContainer.offsetHeight;
                            
                            // Ajustar posi√ß√£o se necess√°rio
                            if (contentHeight <= containerHeight) {
                                chatScroll.scrollTo(0, 0, 100); // Conte√∫do menor que o container, manter no topo
                            } else if (chatScroll.y < chatScroll.maxScrollY) {
                                chatScroll.scrollTo(0, chatScroll.maxScrollY, 100); // Corrigir se estiver al√©m do fim
                            }
                        }, 200);
                    }
                });
                
                // Garantir que o iScroll seja atualizado periodicamente
                setInterval(function() {
                    if (chatScroll) {
                        chatScroll.refresh();
                        
                        // Verificar e corrigir posi√ß√µes inv√°lidas
                        if (chatScroll.y < chatScroll.maxScrollY) {
                            chatScroll.scrollTo(0, chatScroll.maxScrollY, 100);
                        }
                        
                        // Se o conte√∫do for menor que o container, manter no topo
                        if (messagesContainer.offsetHeight <= chatContainer.clientHeight) {
                            chatScroll.scrollTo(0, 0, 100);
                        }
                    }
                }, 2000);
                
                // Rolagem para o fim, mas apenas se tiver conte√∫do suficiente
                if (messagesContainer.offsetHeight > chatContainer.clientHeight) {
                    scrollToBottom(true);
                }
            }
            
            // Criar bot√£o para rolar para o fim
            function createScrollToBottomButton() {
                const scrollBtn = document.createElement('button');
                scrollBtn.id = 'scroll-to-bottom';
                scrollBtn.innerHTML = '&darr;';
                scrollBtn.style.position = 'fixed';
                scrollBtn.style.bottom = '70px';
                scrollBtn.style.right = '15px';
                scrollBtn.style.width = '45px';
                scrollBtn.style.height = '45px';
                scrollBtn.style.borderRadius = '50%';
                scrollBtn.style.background = '#00a884';
                scrollBtn.style.color = 'white';
                scrollBtn.style.border = 'none';
                scrollBtn.style.fontSize = '22px';
                scrollBtn.style.fontWeight = 'bold';
                scrollBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                scrollBtn.style.cursor = 'pointer';
                scrollBtn.style.zIndex = '1000';
                scrollBtn.style.display = 'none';
                document.body.appendChild(scrollBtn);
                
                // Mostrar o bot√£o quando rolar para cima
                if (chatScroll) {
                    chatScroll.on('scroll', function() {
                        if (this.y < this.maxScrollY + 100) {
                            scrollBtn.style.display = 'none';
                        } else {
                            scrollBtn.style.display = 'block';
                        }
                    });
                }
                
                // Rolar para o fim ao clicar
                scrollBtn.addEventListener('click', function() {
                    scrollToBottom();
                });
            }
            
            // Preparar para receber entrada do usu√°rio
            function waitForUserInput() {
                chatData.waitingForUserInput = true;
                // Remover o foco autom√°tico para evitar que o teclado apare√ßa sozinho
                // O usu√°rio precisa clicar manualmente para abrir o teclado
            }
            
            // Eventos para iniciar o chat (√öNICO EVENT LISTENER)
            startChatBtn.addEventListener('click', function() {
                // Verificar se o chat j√° foi iniciado para evitar cliques m√∫ltiplos
                if (chatData.isChatStarted) return;
                
                // Desabilitar o bot√£o temporariamente para evitar cliques m√∫ltiplos
                startChatBtn.disabled = true;
                startChatBtn.style.opacity = '0.6';
                startChatBtn.style.cursor = 'not-allowed';
                
                // Certificar-se de que o indicador de carregamento est√° centralizado
                setTimeout(() => {
                    if (loadingIndicator) {
                        loadingIndicator.style.left = '50%';
                        loadingIndicator.style.top = '50%';
                        loadingIndicator.style.transform = 'translate(-50%, -50%)';
                    }
                }, 300);
                
                // Configurar rolagem inicial
                setTimeout(function() {
                    const chatContainer = document.getElementById('chat-container');
                    if (chatContainer) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    scrollToBottom(true);
                    userHasScrolled = false;
                    shouldAutoScroll = true;
                }, 1000);
                
                // Iniciar o chat
                startChat();
            });
            
            // Configurar bot√£o de altern√¢ncia de vers√£o
            const versionToggle = document.getElementById('version-toggle');
            const versionIndicator = document.getElementById('version-indicator');
            
            if (versionToggle && versionIndicator) {
                // Inicializar com o valor atual
                versionIndicator.textContent = chatData.experimentID === "v1-main" ? "MAIN" : "EXP";
                versionToggle.style.backgroundColor = chatData.experimentID === "v1-main" ? "rgba(255,255,255,0.1)" : "rgba(0,255,255,0.2)";
                
                versionToggle.addEventListener('click', function() {
                    // Alternar entre main e experimental
                    if (chatData.experimentID === "v1-main") {
                        chatData.experimentID = "v2-experimental";
                        versionIndicator.textContent = "EXP";
                        versionToggle.style.backgroundColor = "rgba(0,255,255,0.2)";
                    } else {
                        chatData.experimentID = "v1-main";
                        versionIndicator.textContent = "MAIN";
                        versionToggle.style.backgroundColor = "rgba(255,255,255,0.1)";
                    }
                    
                    // Salvar a prefer√™ncia no localStorage
                    try {
                        localStorage.setItem('whatsapp_version', chatData.experimentID);
                    } catch (e) {
                        console.error('Erro ao salvar vers√£o no localStorage:', e);
                    }
                    
                    console.log('Vers√£o alterada para:', chatData.experimentID);
                });
                
                // Verificar se h√° uma prefer√™ncia salva no localStorage
                try {
                    const savedVersion = localStorage.getItem('whatsapp_version');
                    if (savedVersion) {
                        chatData.experimentID = savedVersion;
                        versionIndicator.textContent = chatData.experimentID === "v1-main" ? "MAIN" : "EXP";
                        versionToggle.style.backgroundColor = chatData.experimentID === "v1-main" ? "rgba(255,255,255,0.1)" : "rgba(0,255,255,0.2)";
                    }
                    
                    // Registrar a vers√£o no console para debug
                    console.log('Vers√£o carregada do localStorage:', chatData.experimentID);
                } catch (e) {
                    console.error('Erro ao ler vers√£o do localStorage:', e);
                }
            }
            
            // Enviar mensagem ao pressionar Enter
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && chatData.waitingForUserInput) {
                    e.preventDefault();
                    const userInput = messageInput.value.trim();
                    if (userInput) {
                        chatData.waitingForUserInput = false;
                        processUserInput(userInput);
                        }
                    }
                });
            
            // Enviar mensagem ao clicar no bot√£o
            sendButton.addEventListener('click', function() {
                if (chatData.waitingForUserInput) {
                    const userInput = messageInput.value.trim();
                    if (userInput) {
                        chatData.waitingForUserInput = false;
                        processUserInput(userInput);
                    }
                }
            });
            
            // Eventos para desbloquear √°udio no iOS
            document.addEventListener('touchstart', unlockAudioForIOS, {once: true});
            document.addEventListener('click', unlockAudioForIOS, {once: true});
            
            // CORRE√á√ÉO: Lidar com o teclado de forma mais robusta
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', function() {
                    if (chatData.isChatStarted) {
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;
                        
                        if (keyboardHeight > 150) {
                            // Teclado vis√≠vel
                            document.body.classList.add('keyboard-open');
                            
                            // Adicionar um atraso para rolagem funcionar ap√≥s o teclado abrir completamente
                            setTimeout(scrollToBottom, 300);
                        } else {
                            // Teclado fechado
                            document.body.classList.remove('keyboard-open');
                        }
                    }
                });
            }
            
            // Adicionar eventos de toque para dispositivos m√≥veis - REMOVIDO (duplicado)
            
            // Melhorar tratamento de orienta√ß√£o
            window.addEventListener('orientationchange', function() {
                // Aguardar a conclus√£o da mudan√ßa de orienta√ß√£o
                setTimeout(() => {
                    if (chatData.isChatStarted) {
                        scrollToBottom();
                    }
                }, 500); // Um pouco mais de tempo para a rota√ß√£o ser conclu√≠da
            });
            
            // Prevenir zoom em inputs e eventos de double-tap no iOS
            document.addEventListener('gesturestart', (e) => e.preventDefault());
            document.addEventListener('touchmove', (e) => {
                if (e.scale !== 1) e.preventDefault();
            }, { passive: false });

            // Criar bot√£o de rolagem para o fim (consolidado)
                const scrollButton = document.createElement('button');
            scrollButton.id = 'scroll-down-button';
                scrollButton.innerHTML = '‚Üì';
                scrollButton.style.position = 'fixed';
                scrollButton.style.right = '16px';
                scrollButton.style.bottom = '70px';
                scrollButton.style.width = '40px';
                scrollButton.style.height = '40px';
                scrollButton.style.borderRadius = '50%';
                scrollButton.style.backgroundColor = '#00a884';
                scrollButton.style.color = 'white';
                scrollButton.style.border = 'none';
                scrollButton.style.fontSize = '20px';
                scrollButton.style.fontWeight = 'bold';
                scrollButton.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                scrollButton.style.zIndex = '1000';
                scrollButton.style.display = 'none';
                document.body.appendChild(scrollButton);
                
            // Monitorar eventos de rolagem
                    if (chatContainer) {
                chatContainer.addEventListener('scroll', function() {
                    // Detectar quando o usu√°rio est√° rolando
                    if (!isScrolling) {
                        userHasScrolled = true;
                        isScrolling = true;
                        
                        // Limpar o temporizador se j√° existir
                        if (window.scrollTimeout) {
                            clearTimeout(window.scrollTimeout);
                        }
                        
                        // Definir temporizador para considerar que a rolagem terminou
                        window.scrollTimeout = setTimeout(function() {
                            isScrolling = false;
                            
                            // Se estiver pr√≥ximo do fim, permitir auto-scroll novamente
                            if (isNearBottom()) {
                                userHasScrolled = false;
                                shouldAutoScroll = true;
                                hideScrollButton();
                            } else {
                                shouldAutoScroll = false;
                                showScrollButton();
                            }
                        }, 150);
                    }
                    
                    lastScrollPosition = chatContainer.scrollTop;
                }, { passive: true });
                
                // Adicionar evento de clique ao bot√£o de rolagem
                scrollButton.addEventListener('click', function() {
                    userHasScrolled = false;
                    shouldAutoScroll = true;
                    scrollToBottom(true);
                    hideScrollButton();
                });
                
                // Desativar todos os outros listeners que possam interferir
                chatContainer.ontouchstart = null;
                chatContainer.ontouchmove = null;
                chatContainer.ontouchend = null;
            }
            
            // Garantir que o messageInput n√£o fa√ßa a p√°gina rolar automaticamente
            if (messageInput) {
                messageInput.addEventListener('focus', function() {
                    // Evitar que o foco cause rolagem autom√°tica
                    setTimeout(function() {
                        if (userHasScrolled && !isNearBottom()) {
                            // N√£o fazemos nada se o usu√°rio rolou para cima e n√£o est√° no fim
                        } else {
                            scrollToBottom(true);
                        }
                    }, 300);
                });
            }
            
            // NOVO: Verificar se o usu√°rio est√° pr√≥ximo do final da conversa
            function isNearBottom() {
                if (!chatContainer) return true;
                
                const threshold = 150; // pixels
                const position = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight;
                return position < threshold;
            }


            // Fun√ß√£o complementar de espera de resposta do usu√°rio
            async function waitForInput() {
                return new Promise((resolve) => {
                    const messageInput = document.getElementById('message-input');
                    const sendButton = document.getElementById('send-btn');
                    
                    const handleInput = () => {
                        const message = messageInput.value.trim();
                        if (message) {
                            messageInput.value = '';
                            addMessage({
                                type: 'text',
                                content: message
                            }, true).then(() => {
                                // Remove os event listeners
                                sendButton.removeEventListener('click', handleInput);
                                messageInput.removeEventListener('keypress', handleEnter);
                                
                                resolve();
                            }).catch(err => {
                                console.error('Erro ao adicionar mensagem:', err);
                                resolve(); // Resolve mesmo com erro para n√£o travar o fluxo
                            });
                        }
                    };
                    
                    const handleEnter = (e) => {
                        if (e.key === 'Enter') {
                            handleInput();
                        }
                    };
                    
                    // Adiciona event listeners para capturar a resposta
                    sendButton.addEventListener('click', handleInput);
                    messageInput.addEventListener('keypress', handleEnter);
                });
            }
            
            // Implementa√ß√£o do fluxo N8N
            async function initializeN8NFlow() {
                // Iniciar com Step 0 no N8N
                chatData.currentStep = 0;
                
                // Mostrar indicador de digita√ß√£o antes de enviar para N8N
                showTypingIndicator();
                
                // Enviar step 0 para N8N e aguardar resposta
                const n8nResponse = await sendToN8N('0');
                
                // Remover indicador de digita√ß√£o
                hideTypingIndicator();
                
                if (n8nResponse) {
                    // Processar resposta do N8N e mostrar mensagens
                    await processN8NResponse(n8nResponse);
                } else {
                    // Fallback caso N8N n√£o responda
                    await showFallbackWelcome();
                }
                
                waitForUserInput();
            }
            
            // Processar resposta do N8N e mostrar mensagens
            async function processN8NResponse(response) {
                console.log('Processando resposta N8N:', response);
                
                // Verificar se alguma mensagem cont√©m "repeat": "S"
                let shouldRepeat = false;
                const messages = [response.message1, response.message2, response.message3, response.message4, response.message5, response.message6, response.message7];
                
                for (let message of messages) {
                    if (message && message.repeat === "S") {
                        shouldRepeat = true;
                        break;
                    }
                }
                
                // Se deve repetir, voltar o step para o anterior (apenas para steps 1 e 2)
                if (shouldRepeat && (chatData.currentStep === 1 || chatData.currentStep === 2)) {
                    console.log('Repetindo step devido a repeat: S');
                    chatData.currentStep = chatData.currentStep - 1;
                    // Limpar dados tempor√°rios quando h√° repeti√ß√£o
                    if (chatData.currentStep === 0) {
                        chatData.tempUserName = null;
                    } else if (chatData.currentStep === 1) {
                        chatData.tempUserPhone = null;
                    }
                } else {
                    // Se n√£o deve repetir, confirmar os dados tempor√°rios
                    if (chatData.currentStep === 1 && chatData.tempUserName) {
                        chatData.userName = chatData.tempUserName;
                        chatData.tempUserName = null;
                        
                        // PIXEL META: Contato - Usu√°rio forneceu nome
                        try {
                            // Separar nome em primeiro e √∫ltimo nome
                            const nameParts = chatData.userName.trim().split(' ');
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';
                            
                            await sendMetaConversionEvent('Contact', {
                                firstName: firstName,
                                lastName: lastName,
                                phone: chatData.userPhone || null,
                                country: 'Portugal'
                            }, {
                                content_type: 'user_info',
                                content_name: 'Nome Fornecido',
                                currency: 'EUR'
                            });
                        } catch (error) {
                            console.error('Erro ao enviar pixel Contact (nome):', error);
                        }
                    }
                    
                    if (chatData.currentStep === 2 && chatData.tempUserPhone) {
                        chatData.userPhone = chatData.tempUserPhone;
                        chatData.tempUserPhone = null;
                        
                        // PIXEL META: Contato - Usu√°rio forneceu telefone
                        try {
                            // Separar nome em primeiro e √∫ltimo nome (se j√° dispon√≠vel)
                            const nameParts = (chatData.userName || '').trim().split(' ');
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';
                            
                            await sendMetaConversionEvent('Contact', {
                                firstName: firstName,
                                lastName: lastName,
                                phone: chatData.userPhone,
                                country: 'Portugal'
                            }, {
                                content_type: 'user_info',
                                content_name: 'Telefone Fornecido',
                                currency: 'EUR'
                            });
                        } catch (error) {
                            console.error('Erro ao enviar pixel Contact (telefone):', error);
                        }
                    }
                }
                
                // Verificar se h√° mensagens na resposta
                if (response.message1) {
                    await showN8NMessage(response.message1);
                }
                if (response.message2) {
                    await showN8NMessage(response.message2);
                }
                if (response.message3) {
                    await showN8NMessage(response.message3);
                }
                if (response.message4) {
                    await showN8NMessage(response.message4);
                }
                if (response.message5) {
                    await showN8NMessage(response.message5);
                }
                if (response.message6) {
                    await showN8NMessage(response.message6);
                }
                if (response.message7) {
                    await showN8NMessage(response.message7);
                }
            }
            
            // Mostrar mensagem individual do N8N
            async function showN8NMessage(messageData) {
                let delay = parseInt(messageData.delay) * 1000 || 3000;
                
                // Mostrar indicador de digita√ß√£o antes do delay
                showTypingIndicator();
                
                // Aguardar delay antes de mostrar a mensagem
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // Remover indicador de digita√ß√£o
                hideTypingIndicator();
                
                if (messageData.imagem) {
                    await addMessage({
                        type: 'image',
                        imageUrl: messageData.imagem,
                        text: messageData.texto || ''
                    });
                } else if (messageData.audio) {
                    await addMessage({
                        type: 'audio',
                        audioUrl: messageData.audio,
                        text: messageData.texto || ''
                    });
                } else if (messageData.youtube_id) {
                    await addMessage({
                        type: 'youtube',
                        videoId: messageData.youtube_id,
                        text: messageData.texto || ''
                    });
                } else if (messageData.texto) {
                    await addMessage({
                        type: 'text',
                        content: messageData.texto
                    });
                }
            }
            
            // Fallback caso N8N n√£o responda
            async function showFallbackWelcome() {
                // N8N gerencia todas as mensagens - n√£o mostrar fallback
                console.log('N8N n√£o respondeu - aguardando resposta do servidor');
            }
            
            // Etapa 6: Perguntar sobre d√∫vidas
            async function askForQuestions() {
                chatData.currentStep = 6;
                
                // Enviar step 6 para N8N
                showTypingIndicator(); // Mostrar indicador de digita√ß√£o
                await sendToN8N('6', {
                    NOME: chatData.userName,
                    CONTATO: chatData.userPhone,
                    PROBLEMA_RELATADO: chatData.userProblem
                });
                hideTypingIndicator(); // Remover indicador de digita√ß√£o
                
                addMessage({
                    type: 'text',
                    content: `${chatData.userName}, tem alguma **d√∫vida sobre o produto ou sobre o tratamento? Podemos prosseguir?**`
                });
                
                waitForUserInput();
            }
            
            // Processar resposta da etapa 5
            async function processStep5Response(userInput) {
                // Verificar se a resposta √© positiva
                const positiveResponses = ["sim", "pode", "vamos", "quero", "aceito", "ok", "concordo", "bora", "seguir", "prosseguir", "continuar", "claro", "podemos", "vou", "comprar", "adquirir"];
                const negativeResponses = ["n√£o", "d√∫vida", "duvida", "pergunta", "ainda n√£o", "espere", "espera", "tenho", "gostaria", "preciso"];
                
                let isPositive = positiveResponses.some(word => userInput.toLowerCase().includes(word));
                let isNegative = negativeResponses.some(word => userInput.toLowerCase().includes(word));
                
                if (isPositive && !isNegative) {
                    // Resposta positiva - prosseguir para step 6 (popup de vendas)
                    chatData.currentStep = 6;
                    
                    console.log('üîÑ Chamando showAddressPopup() - Step:', chatData.currentStep);
                    
                    // Mostrar popup de confirma√ß√£o de vendas
                    showAddressPopup();
                    
                    // REMOVIDO: setTimeout que mudava currentStep muito rapidamente
                    // Agora o currentStep s√≥ muda quando o usu√°rio confirmar no popup
                    
                    return;
                }
                
                // Resposta negativa ou d√∫vida - processar como d√∫vida
                // Mostrar indicador de digita√ß√£o
                showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Enviar d√∫vida para N8N
                const n8nResponse = await sendQuestionToN8N(userInput);
                
                let aiResponse = null;
                
                // Verificar se N8N retornou uma resposta v√°lida
                if (n8nResponse && n8nResponse.resposta) {
                    aiResponse = n8nResponse.resposta;
                } else if (n8nResponse && n8nResponse.message) {
                    aiResponse = n8nResponse.message;
                } else if (n8nResponse && n8nResponse.message1 && n8nResponse.message1.texto) {
                    aiResponse = n8nResponse.message1.texto;
                } else {
                    // S√≥ usar fallback se N8N realmente n√£o respondeu
                    console.warn('N8N n√£o retornou resposta v√°lida para d√∫vida:', n8nResponse);
                    aiResponse = "Obrigado pela sua pergunta! Nosso produto √© seguro e eficaz. Tem mais alguma d√∫vida ou podemos prosseguir?";
                }
                
                // Armazenar a resposta da IA
                if (!chatData.conversaIA) {
                    chatData.conversaIA = [];
                }
                
                chatData.conversaIA.push({
                    pergunta: userInput,
                    resposta: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
                // Adicionar a resposta da IA ao chat
                hideTypingIndicator();
                
                if (aiResponse) {
                    addMessage({
                        type: 'text',
                        content: aiResponse
                    });
                } else {
                    console.error('Erro: aiResponse √© nulo na step 5');
                    addMessage({
                        type: 'text',
                        content: "Desculpe, ocorreu um erro ao processar sua pergunta. Pode repetir?"
                    });
                }
                
                // Continuar aguardando input na step 5
                waitForUserInput();
            }

            // Processar d√∫vidas do utilizador usando IA via N8N
            async function processQuestions(userQuestion) {
                // Armazenar a pergunta
                chatData.userQuestions.push(userQuestion);
                
                // Verificar se a pergunta indica aceita√ß√£o para prosseguir
                const positiveResponses = ["sim", "pode", "vamos", "quero", "aceito", "ok", "concordo", "bora", "seguir", "prosseguir", "continuar", '1 m√™s', '2 meses', '3 meses'];
                const negativeResponses = ["n√£o", "d√∫vida", "duvida", "pergunta", "ainda n√£o", "espere", "espera"];
                
                let isPositive = positiveResponses.some(word => userQuestion.toLowerCase().includes(word));
                let isStillAsking = negativeResponses.some(word => userQuestion.toLowerCase().includes(word));
                
                if (isPositive && !isStillAsking) {
                    // Utilizador quer prosseguir para o preenchimento do formul√°rio
                    showTypingIndicator(); // Mostrar indicador de digita√ß√£o
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    hideTypingIndicator(); // Remover indicador de digita√ß√£o
                    startFormFilling();
                    return;
                }
                
                // Mostrar indicador de digita√ß√£o
                showTypingIndicator();
                const isFirstResponse = chatData.conversaIA && chatData.conversaIA.length === 0;
                const typingDelay = isFirstResponse ? 1000 + Math.random() * 1000 : 2000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, typingDelay));
                
                // Enviar d√∫vida para N8N
                const n8nResponse = await sendQuestionToN8N(userQuestion);
                
                let aiResponse = null;
                
                // Verificar se N8N retornou uma resposta v√°lida
                if (n8nResponse && n8nResponse.resposta) {
                    aiResponse = n8nResponse.resposta;
                } else if (n8nResponse && n8nResponse.message) {
                    aiResponse = n8nResponse.message;
                } else if (n8nResponse && n8nResponse.message1 && n8nResponse.message1.texto) {
                    aiResponse = n8nResponse.message1.texto;
                } else {
                    // S√≥ usar fallback se N8N realmente n√£o respondeu
                    console.warn('N8N n√£o retornou resposta v√°lida para pergunta:', n8nResponse);
                    aiResponse = "Obrigado pela sua pergunta! Nosso produto √© seguro e eficaz. Podemos prosseguir?";
                }
                
                // Armazenar a resposta da IA junto com a pergunta
                if (!chatData.conversaIA) {
                    chatData.conversaIA = [];
                }
                
                chatData.conversaIA.push({
                    pergunta: userQuestion,
                    resposta: aiResponse,
                    timestamp: new Date().toISOString()
                });
                
                // Adicionar a resposta da IA ao chat
                hideTypingIndicator();
                
                if (aiResponse) {
                    addMessage({
                        type: 'text',
                        content: aiResponse
                    });
                } else {
                    console.error('Erro: aiResponse √© nulo na processQuestions');
                    addMessage({
                        type: 'text',
                        content: "Desculpe, ocorreu um erro ao processar sua pergunta. Pode repetir?"
                    });
                }
                
                waitForUserInput();
            }
            
            // Processar d√∫vidas p√≥s-venda na etapa 7
            async function processPostSaleQuestions(userInput) {
                // Mostrar indicador de digita√ß√£o
                showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Enviar d√∫vida p√≥s-venda para N8N
                const n8nResponse = await sendToN8N('7', {
                    nome: chatData.userName,
                    telefone: chatData.userPhone,
                    duvida_pos_venda: userInput,
                    IA: 'PosVenda'
                });
                
                let aiResponse = null;
                
                // Verificar se N8N retornou uma resposta v√°lida
                if (n8nResponse && n8nResponse.resposta) {
                    aiResponse = n8nResponse.resposta;
                } else if (n8nResponse && n8nResponse.message) {
                    aiResponse = n8nResponse.message;
                } else if (n8nResponse && n8nResponse.message1 && n8nResponse.message1.texto) {
                    aiResponse = n8nResponse.message1.texto;
                } else {
                    // S√≥ usar fallback se N8N realmente n√£o respondeu
                    console.warn('N8N n√£o retornou resposta v√°lida para d√∫vida p√≥s-venda:', n8nResponse);
                    aiResponse = "Obrigado pela sua pergunta! Nossa equipe est√° aqui para ajudar. Tem mais alguma d√∫vida sobre seu pedido?";
                }
                
                // Adicionar a resposta da IA ao chat
                hideTypingIndicator();
                
                if (aiResponse) {
                    addMessage({
                        type: 'text',
                        content: aiResponse
                    });
                } else {
                    console.error('Erro: aiResponse √© nulo na processPostSaleQuestions');
                    addMessage({
                        type: 'text',
                        content: "Desculpe, ocorreu um erro ao processar sua pergunta. Pode repetir?"
                    });
                }
                
                // Continuar aguardando input na step 7 (p√≥s-venda)
                waitForUserInput();
            }

            // Etapa 7: Iniciar preenchimento do formul√°rio
            async function startFormFilling() {
                chatData.currentStep = 7;
                
                // Mostrar indicador de digita√ß√£o antes da mensagem
                showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 1500));
                hideTypingIndicator();
                
                const textDelay1 = await addMessage({
                    type: 'text',
                    content: `Perfeito! Ent√£o vamos confirmar os seus dados para o envio üìç`
                });
                
                await new Promise(resolve => setTimeout(resolve, textDelay1));
                
                // Em vez de continuar com mensagens, mostrar o popup de confirma√ß√£o de endere√ßo
                showAddressPopup();
            }
            
            // Fun√ß√£o para mostrar o popup de confirma√ß√£o de endere√ßo
            async function showAddressPopup() {
                console.log('üöÄ showAddressPopup() iniciada');
                
                const popup = document.getElementById('address-popup');
                const popupName = document.getElementById('popup-name');
                const popupPhone = document.getElementById('popup-phone');
                
                console.log('üìã Elementos encontrados:', {
                    popup: !!popup,
                    popupName: !!popupName,
                    popupPhone: !!popupPhone
                });
                
                // Preencher os campos com os dados j√° coletados
                if (popupName) popupName.value = chatData.userName || '';
                if (popupPhone) popupPhone.value = chatData.userPhone || '';
                
                // Mostrar o popup
                if (popup) {
                    console.log('‚úÖ Exibindo popup - display: flex');
                    popup.style.display = 'flex';
                    
                    // Verificar se realmente foi exibido
                    setTimeout(() => {
                        const computedStyle = window.getComputedStyle(popup);
                        console.log('üîç Estado do popup ap√≥s exibi√ß√£o:', {
                            display: computedStyle.display,
                            visibility: computedStyle.visibility,
                            opacity: computedStyle.opacity,
                            zIndex: computedStyle.zIndex
                        });
                    }, 100);
                } else {
                    console.error('‚ùå Elemento popup n√£o encontrado!');
                }
                
                // Configurar eventos para edi√ß√£o de campos
                console.log('‚öôÔ∏è Configurando eventos do popup');
                setupPopupEvents();
            }
            
            // Configurar eventos do popup
            function setupPopupEvents() {
                const popup = document.getElementById('address-popup');
                const popupContent = popup.querySelector('.address-popup-content');
                const editName = document.getElementById('edit-name');
                const editPhone = document.getElementById('edit-phone');
                const popupName = document.getElementById('popup-name');
                const popupPhone = document.getElementById('popup-phone');
                const confirmBtn = document.getElementById('confirm-address-btn');
                const streetInput = document.getElementById('popup-address-street');
                const postalInput = document.getElementById('popup-address-postal');
                const closeBtn = document.getElementById('popup-close-btn');

                // Configurar bot√£o X para fechar popup
                if (closeBtn) {
                    closeBtn.addEventListener('click', async function() {
                        console.log('üö´ Usu√°rio clicou no bot√£o X - Iniciando modo fallback');
                        
                        // Fechar o popup
                        popup.style.display = 'none';
                        
                        // Ativar modo fallback
                        chatData.fallbackMode = true;
                        chatData.currentStep = 6.5; // Step especial para fallback
                        
                        // Enviar mensagem do Dr. Bruno Celso
                        await addMessage({
                            type: 'text',
                            content: '**Mudou de ideia? Tem alguma d√∫vida antes de comprar?**',
                            sender: 'bot'
                        });
                        
                        // Enviar para N8N com IA: Fallback_venda
                        try {
                            const n8nResponse = await sendToN8N('fallback', {
                                IA: 'Fallback_venda',
                                duvida: 'Usuario fechou popup de compra',
                                fallback_mode: true
                            });
                            
                            if (n8nResponse) {
                                console.log('‚úÖ Fallback enviado para N8N com sucesso');
                            }
                        } catch (error) {
                            console.error('‚ùå Erro ao enviar fallback para N8N:', error);
                        }
                        
                        // Aguardar resposta do usu√°rio
                        waitForUserInput();
                    });
                }

                // Fun√ß√£o para enviar d√∫vida no modo fallback
                async function sendFallbackQuestion(question) {
                    try {
                        chatData.fallbackQuestion = question;
                        
                        // Verificar se a pergunta √© relacionada a pre√ßo
                        const priceKeywords = ['pre√ßo', 'preco', 'valor', 'custa', 'custo', 'euro', 'euros', '‚Ç¨', 'dinheiro', 'pagar', 'barato', 'caro', 'desconto'];
                        const isAboutPrice = priceKeywords.some(keyword => 
                            question.toLowerCase().includes(keyword)
                        );
                        
                        if (isAboutPrice && !chatData.discountApplied) {
                            // Aplicar desconto para 68 EUR
                            chatData.discountApplied = true;
                            
                            await addMessage({
                                type: 'text',
                                content: `Entendo sua preocupa√ß√£o com o pre√ßo! üí∞
                                
Como voc√™ demonstrou interesse real, vou fazer uma **oferta especial** s√≥ para voc√™:

**De 97‚Ç¨ por apenas 68‚Ç¨!** üéâ

Esta √© uma oportunidade √∫nica. O que acha?`,
                                sender: 'bot'
                            });
                            
                            // Aguardar resposta sobre o desconto
                            waitForUserInput();
                            
                        } else {
                            // Enviar d√∫vida para N8N
                            const payload = {
                                Step: 'fallback_duvida',
                                session_id: chatData.session_id,
                                nome: chatData.userName || '',
                                telefone: chatData.userPhone || '',
                                duvida: question,
                                IA: 'Fallback_venda',
                                fonte: 'whatsapp',
                                fallback_mode: true
                            };

                            console.log('üì§ Enviando d√∫vida fallback para N8N:', payload);

                            const response = await fetch(`${N8N_CONFIG.baseUrl}${N8N_CONFIG.endpoints.process}`, {
                                method: 'POST',
                                mode: 'cors',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });

                            if (response.ok) {
                                const data = await response.json();
                                console.log('üì• Resposta N8N fallback:', data);
                                
                                // Processar resposta da IA
                                if (data && (data.resposta || data.message || (data.message1 && data.message1.texto))) {
                                    const aiResponse = data.resposta || data.message || data.message1.texto;
                                    
                                    await addMessage({
                                        type: 'text',
                                        content: aiResponse,
                                        sender: 'bot'
                                    });
                                    
                                    // Aguardar pr√≥xima resposta
                                    waitForUserInput();
                                } else {
                                    console.warn('‚ö†Ô∏è N8N n√£o retornou resposta v√°lida para fallback');
                                    await addMessage({
                                        type: 'text',
                                        content: 'Entendo sua d√∫vida. Posso esclarecer mais alguma coisa para voc√™?',
                                        sender: 'bot'
                                    });
                                    waitForUserInput();
                                }
                            } else {
                                console.error('‚ùå Erro HTTP na resposta N8N fallback:', response.status);
                                await addMessage({
                                    type: 'text',
                                    content: 'Entendo sua d√∫vida. Posso esclarecer mais alguma coisa para voc√™?',
                                    sender: 'bot'
                                });
                                waitForUserInput();
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao processar d√∫vida fallback:', error);
                        await addMessage({
                            type: 'text',
                            content: 'Entendo sua d√∫vida. Posso esclarecer mais alguma coisa para voc√™?',
                            sender: 'bot'
                        });
                        waitForUserInput();
                    }
                }

                // Fun√ß√£o para mostrar popup baseado no tipo (com ou sem desconto)
                async function showFinalPopup() {
                    console.log('üéØ Mostrando popup final');
                    
                    const deliveryImage = document.getElementById('popup-delivery-image');
                    const countdownTimer = document.getElementById('countdown-timer');
                    
                    if (chatData.discountApplied) {
                        // Se desconto foi aplicado, usar imagem de fallback
                        console.log('üí∞ Desconto aplicado - Usando imagem de fallback');
                        if (deliveryImage) {
                            deliveryImage.src = 'https://4lifenutrition.site/Assets/Fallback.webp';
                            deliveryImage.alt = 'Oferta Especial com Desconto';
                        }
                        
                        // Mostrar cron√¥metro apenas no modo fallback
                        if (countdownTimer) {
                            countdownTimer.style.display = 'block';
                        }
                        
                        // Remover o bot√£o X (popup sem possibilidade de fechar)
                        popup.classList.add('popup-no-close');
                    } else {
                        // Se n√£o h√° desconto, manter imagem original
                        console.log('üì¶ Sem desconto - Mantendo imagem original');
                        if (deliveryImage) {
                            deliveryImage.src = 'https://4lifenutrition.site/Assets/ctt_entregas.webp';
                            deliveryImage.alt = 'Entrega';
                        }
                        
                        // Esconder cron√¥metro no modo normal
                        if (countdownTimer) {
                            countdownTimer.style.display = 'none';
                        }
                        
                        // Remover o bot√£o X tamb√©m (popup final sempre sem X)
                        popup.classList.add('popup-no-close');
                    }
                    
                    // Mostrar o popup
                    popup.style.display = 'flex';
                    
                    // Preencher os campos
                    if (popupName) popupName.value = chatData.userName || '';
                    if (popupPhone) popupPhone.value = chatData.userPhone || '';
                    
                    // Iniciar cron√¥metro apenas se h√° desconto aplicado
                    if (chatData.discountApplied) {
                        startCountdownTimer();
                    }
                    
                    console.log('‚úÖ Popup final exibido', chatData.discountApplied ? 'com desconto' : 'sem desconto');
                }

                // Fun√ß√£o para iniciar o cron√¥metro de 10 minutos
                function startCountdownTimer() {
                    const countdownDisplay = document.getElementById('countdown-display');
                    const countdownTimer = document.getElementById('countdown-timer');
                    
                    if (!countdownDisplay || !countdownTimer) return;
                    
                    let timeLeft = 10 * 60; // 10 minutos em segundos
                    
                    const timer = setInterval(() => {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        
                        // Formatar o display
                        countdownDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Quando restam menos de 2 minutos, acelerar a anima√ß√£o
                        if (timeLeft <= 120 && !countdownTimer.classList.contains('countdown-urgent')) {
                            countdownTimer.classList.add('countdown-urgent');
                        }
                        
                        // Quando o tempo acabar
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            countdownDisplay.textContent = 'EXPIROU';
                            countdownTimer.style.background = 'linear-gradient(45deg, #666, #444)';
                            countdownTimer.style.animation = 'none';
                            
                            // Opcional: Fechar o popup ou mostrar mensagem
                            setTimeout(() => {
                                if (popup && popup.style.display === 'flex') {
                                    popup.style.display = 'none';
                                    addMessage({
                                        type: 'text',
                                        content: '‚è∞ A oferta especial expirou. Entre em contato conosco para mais informa√ß√µes!'
                                    });
                                }
                            }, 2000);
                        }
                        
                        timeLeft--;
                    }, 1000);
                    
                    // Armazenar o timer para poder cancel√°-lo se necess√°rio
                    window.countdownTimer = timer;
                }

                // Adicionar fun√ß√£o ao escopo global para uso em processamento de mensagens
                window.sendFallbackQuestion = sendFallbackQuestion;
                window.showFinalPopup = showFinalPopup;

                // Permitir edi√ß√£o do nome
                if (editName && popupName) {
                    editName.addEventListener('click', function() {
                        popupName.readOnly = false;
                        popupName.classList.remove('readonly');
                        popupName.focus();
                    });
                    
                    popupName.addEventListener('blur', function() {
                        popupName.readOnly = true;
                        popupName.classList.add('readonly');
                        chatData.userName = popupName.value;
                    });
                }
                
                // Permitir edi√ß√£o do telefone
                if (editPhone && popupPhone) {
                    editPhone.addEventListener('click', function() {
                        popupPhone.readOnly = false;
                        popupPhone.classList.remove('readonly');
                        popupPhone.focus();
                    });
                    
                    popupPhone.addEventListener('blur', function() {
                        popupPhone.readOnly = true;
                        popupPhone.classList.add('readonly');
                        chatData.userPhone = popupPhone.value;
                    });
                }
                
                // Fechar o popup ao clicar fora dele (mas n√£o permitir fechar facilmente)
                popup.addEventListener('click', function(e) {
                    // Apenas fechar se clicar diretamente no fundo do popup (n√£o no conte√∫do)
                    if (e.target === popup) {
                        // Verificar se os campos obrigat√≥rios est√£o preenchidos
                        if (streetInput.value.trim() && postalInput.value.trim()) {
                            popup.style.display = 'none';
                        } else {
                            // Mostrar uma mensagem sutil para incentivar o preenchimento
                            const alertElement = document.createElement('div');
                            alertElement.style.position = 'absolute';
                            alertElement.style.bottom = '10px';
                            alertElement.style.left = '0';
                            alertElement.style.right = '0';
                            alertElement.style.textAlign = 'center';
                            alertElement.style.color = '#e74c3c';
                            alertElement.style.fontSize = '14px';
                            alertElement.style.padding = '5px';
                            alertElement.textContent = 'Por favor, preencha a morada para continuar';
                            alertElement.style.animation = 'fadeIn 0.3s ease-out';
                            
                            popup.appendChild(alertElement);
                            
                            // Remover ap√≥s alguns segundos
                            setTimeout(() => {
                                alertElement.remove();
                            }, 3000);
                        }
                    }
                });
                
                // Evitar que cliques no conte√∫do do popup propaguem para o fundo
                popupContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // Configurar bot√£o de confirma√ß√£o
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function() {
                        // Validar campos obrigat√≥rios
                        if (!popupName.value.trim()) {
                            alert('Por favor, preencha o nome completo.');
                            return;
                        }
                        
                        if (!popupPhone.value.trim()) {
                            alert('Por favor, preencha o n√∫mero de telefone.');
                            return;
                        }
                        
                        if (!streetInput.value.trim()) {
                            alert('Por favor, preencha a rua e n√∫mero.');
                            return;
                        }
                        
                        if (!postalInput.value.trim()) {
                            alert('Por favor, preencha o c√≥digo postal e localidade.');
                            return;
                        }
                        
                        // Verificar se o c√≥digo postal est√° no formato correto (XXXX-XXX)
                        const postalCodeRegex = /\b\d{4}-\d{3}\b/;
                        if (!postalCodeRegex.test(postalInput.value)) {
                            alert('Por favor, insira um c√≥digo postal v√°lido no formato XXXX-XXX (exemplo: 1000-300).');
                            return;
                        }
                        
                        // PIXEL META: Endere√ßo Confirmado - Usu√°rio preencheu dados de entrega
                        try {
                            sendMetaConversionEvent('AddPaymentInfo', {
                                phone: popupPhone.value
                            }, {
                                content_type: 'delivery_info',
                                content_name: 'Dados de Entrega Confirmados',
                                currency: 'EUR',
                                value: 74.98
                            });
                        } catch (error) {
                            console.error('Erro ao enviar pixel AddPaymentInfo:', error);
                        }
                        
                        // Construir endere√ßo completo
                        const fullAddress = `${streetInput.value}, ${postalInput.value}`;
                        
                        // Fechar o popup
                        document.getElementById('address-popup').style.display = 'none';
                        
                        // Parar o cron√¥metro
                        if (window.countdownTimer) {
                            clearInterval(window.countdownTimer);
                            window.countdownTimer = null;
                        }
                        
                        // Atualizar dados
                        chatData.userName = popupName.value;
                        chatData.userPhone = popupPhone.value;
                        chatData.fullAddress = fullAddress;
                        
                        // Mostrar confirma√ß√£o no chat
                        addMessage({
                            type: 'text',
                            content: `Obrigado! Confirmei seus dados:
                            
**Nome:** ${chatData.userName}
**Telefone:** ${chatData.userPhone}
**Morada:** ${chatData.fullAddress}

Seu pedido est√° sendo processado. Vamos finalizar!`
                        });
                        
                        // Prosseguir para finaliza√ß√£o do pedido
                        finalizeOrder(chatData.userPhone);
                    });
                }
            }

            // Fun√ß√£o para finalizar o pedido
            async function finalizeOrder(phone) {
                chatData.currentStep = 8;
                chatData.userPhone = phone;
                
                // Obter a data atual no formato DD/MM/AAAA
                const dataAtual = new Date();
                const dia = String(dataAtual.getDate()).padStart(2, '0');
                const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
                const ano = dataAtual.getFullYear();
                const dataFormatada = `${dia}/${mes}/${ano}`;
                
                // Determinar o nome para salvar (com desconto se aplic√°vel)
                const nomeParaSalvar = chatData.discountApplied ? 
                    `${chatData.userName} (DESCONTO)` : 
                    chatData.userName;
                
                // Determinar o valor e pacote baseado no desconto
                const valorPedido = chatData.discountApplied ? 68.00 : 74.98;
                const pacoteEscolhido = chatData.discountApplied ? 
                    "1 m√™s de tratamento - RENOVAGOLD (68‚Ç¨ - DESCONTO ESPECIAL)" : 
                    "1 m√™s de tratamento - RENOVAGOLD (74,98‚Ç¨)";
                
                // Gerar JSON com as informa√ß√µes - MOVIDO PARA ESCOPO GLOBAL DA FUN√á√ÉO
                const orderData = {
                    NOME: nomeParaSalvar,
                    ENDERE√áO: chatData.fullAddress,
                    CONTATO: chatData.userPhone,
                    PROBLEMA_RELATADO: chatData.userProblem,
                    PERGUNTAS_FEITAS: chatData.userQuestions,
                    CONVERSA_IA: chatData.conversaIA || [],
                    PACOTE_ESCOLHIDO: pacoteEscolhido,
                    DATA: dataFormatada,
                    versao: chatData.experimentID, // Identificador √∫nico de vers√£o
                    DESCONTO_APLICADO: chatData.discountApplied,
                    VALOR_FINAL: valorPedido,
                    MODO_FALLBACK: chatData.fallbackMode || false
                };
                
                // PIXEL META: Comprar - Pedido finalizado com sucesso
                try {
                    sendMetaConversionEvent('Purchase', {
                        phone: chatData.userPhone
                    }, {
                        content_type: 'product',
                        content_name: chatData.discountApplied ? 'RENOVAGOLD - 1 m√™s (DESCONTO)' : 'RENOVAGOLD - 1 m√™s de tratamento',
                        currency: 'EUR',
                        value: valorPedido,
                        num_items: 1
                    });
                } catch (error) {
                    console.error('Erro ao enviar pixel Purchase:', error);
                }
                
                // Garantir que o JSON √© exibido claramente no console
                console.log("%c DADOS DO PEDIDO", "background: #25D366; color: white; padding: 5px; border-radius: 5px; font-size: 16px; font-weight: bold;");
                console.log(JSON.stringify(orderData, null, 2));
                
                // Salvar os dados do pedido em um elemento oculto na p√°gina
                const jsonDataElement = document.createElement('div');
                jsonDataElement.id = 'order-data-json';
                jsonDataElement.style.display = 'none';
                jsonDataElement.textContent = JSON.stringify(orderData);
                document.body.appendChild(jsonDataElement);
                
                // Tamb√©m criar um elemento vis√≠vel apenas durante desenvolvimento
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    const devJsonElement = document.createElement('pre');
                    devJsonElement.id = 'dev-json-data';
                    devJsonElement.style.position = 'fixed';
                    devJsonElement.style.bottom = '10px';
                    devJsonElement.style.right = '10px';
                    devJsonElement.style.background = 'rgba(0,0,0,0.7)';
                    devJsonElement.style.color = 'white';
                    devJsonElement.style.padding = '10px';
                    devJsonElement.style.borderRadius = '5px';
                    devJsonElement.style.maxWidth = '400px';
                    devJsonElement.style.maxHeight = '200px';
                    devJsonElement.style.overflow = 'auto';
                    devJsonElement.style.zIndex = '9999';
                    devJsonElement.style.fontSize = '12px';
                    devJsonElement.textContent = "DADOS DO PEDIDO:\n" + JSON.stringify(orderData, null, 2);
                    document.body.appendChild(devJsonElement);
                }
                
                
                showTypingIndicator(); // Mostrar indicador durante processamento
                await new Promise(resolve => setTimeout(resolve, 7000));
                hideTypingIndicator(); // Remover indicador ap√≥s processamento
                
                await addMessage({
                    type: 'text',
                    content: `**ATEN√á√ÉO!** Leia esta mensagem por completo!
**Parab√©ns pela sua aquisi√ß√£o e obrigado pela confian√ßa.**

O seu pedido foi efetuado e j√° encaminhado para o setor de log√≠stica.

O seu tratamento ser√° enviado pelos **CTT**
**chegar√° √† sua resid√™ncia dentro de 1 a 4 dias √∫teis**.

<div style="margin-top: 15px; text-align: center;">
    <a href="https://wa.me/351924946973?text=ol√°!" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #25D366, #128C7E); color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); transition: all 0.3s ease; border: none;">
        üìû Contactar Log√≠stica Diretamente
    </a>
</div>`
                });
                
                // Mostrar indicador de digita√ß√£o antes da segunda mensagem
                showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 8000));
                hideTypingIndicator();
                
                // Mensagem final
                await addMessage({
                    type: 'text',
                    content: `**estarei aqui para responder qualquer duvida !**`
                });
                
                // Ir para modo p√≥s-venda (step 7) com IA ativa
                chatData.currentStep = 7;
                waitForUserInput();
                
                // DEPOIS: Fazer opera√ß√µes de salvamento em background (n√£o bloquear a UI)
                // Criar uma c√≥pia local do orderData para garantir acesso no setTimeout
                const orderDataCopy = JSON.parse(JSON.stringify(orderData));
                
                setTimeout(async () => {
                    // Finalizar o pedido tempor√°rio via N8N (manter integra√ß√£o)
                    try {
                        const n8nResponse = await sendToN8N('8', {
                            nome: chatData.userName,
                            telefone: chatData.userPhone,
                            endereco: chatData.fullAddress,
                            problema: chatData.userProblem,
                            finalizado: true,
                            IA: 'Finalizado',
                            versao: chatData.experimentID
                        });
                        
                        if (n8nResponse) {
                            console.log('Pedido enviado para N8N com sucesso');
                            // N√ÉO processar a resposta automaticamente para evitar conflito com mensagens locais
                            // await processN8NResponse(n8nResponse); // REMOVIDO
                        }
                    } catch (error) {
                        console.error('Erro ao enviar para N8N:', error);
                    }
                    
                    // Enviar o JSON para o servidor em vez de fazer download
                    try {
                        // Criar um nome de arquivo √∫nico baseado no timestamp e nome do cliente
                        const timestamp = Date.now();
                        const nomeSimplificado = chatData.userName.replace(/[^a-zA-Z0-9]/g, '_').substr(0, 20);
                        const fileName = `pedido_${nomeSimplificado}_${timestamp}.json`;
                        
                        // O caminho √© relativo ao local onde o site est√° hospedado (https://suplements.tech/2025)
                        const uploadResponse = await fetch('https://4lifenutrition.site/2025/pedidos.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                fileName: fileName,
                                fileContent: JSON.stringify(orderDataCopy, null, 2)
                            })
                        });
                        
                        // Obter o texto da resposta primeiro para debug
                        const responseText = await uploadResponse.text();
                        console.log('Resposta bruta do servidor:', responseText);
                        
                        // Tentar parsear o JSON
                        let responseData;
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (jsonError) {
                            console.error('Erro ao parsear resposta JSON:', jsonError);
                            throw new Error('Resposta inv√°lida do servidor');
                        }
                        
                        if (!uploadResponse.ok) {
                            throw new Error(responseData && responseData.message ? responseData.message : 'Falha ao enviar dados para o servidor');
                        }
                        
                        console.log(`Pedido enviado com sucesso para o servidor: ${fileName}`);
                    } catch (error) {
                        console.error('Erro ao enviar dados para o servidor:', error);
                        
                        // Fallback: Tentar salvar localmente
                        try {
                            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orderDataCopy, null, 2));
                            const downloadAnchorNode = document.createElement('a');
                            downloadAnchorNode.setAttribute("href", dataStr);
                            downloadAnchorNode.setAttribute("download", "pedido_"+Date.now()+".json");
                            downloadAnchorNode.style.display = "none";
                            document.body.appendChild(downloadAnchorNode);
                            downloadAnchorNode.click();
                            downloadAnchorNode.remove();
                            
                            console.log('Pedido salvo localmente como backup');
                        } catch (dlError) {
                            console.error('Erro ao tentar salvar localmente:', dlError);
                        }
                    }
                    
                    // Tamb√©m salvar no localStorage para hist√≥rico
                    try {
                        // Obter os pedidos existentes
                        let pedidos = JSON.parse(localStorage.getItem('pedidos_renovagold') || '[]');
                        
                        // Remover pedidos anteriores do mesmo usu√°rio (mesmo telefone) para evitar duplicatas
                        const telefoneAtual = orderDataCopy.CONTATO;
                        pedidos = pedidos.filter(pedido => pedido.CONTATO !== telefoneAtual);
                        
                        // Adicionar o novo pedido com timestamp
                        orderDataCopy.timestamp = new Date().toISOString();
                        orderDataCopy.status = 'FINALIZADO'; // Marcar como pedido finalizado
                        pedidos.push(orderDataCopy);
                        
                        // Salvar de volta no localStorage
                        localStorage.setItem('pedidos_renovagold', JSON.stringify(pedidos));
                        console.log("Pedido final salvo no localStorage (pedidos anteriores do mesmo usu√°rio removidos)!");
                    } catch (error) {
                        console.error('Erro ao salvar no localStorage:', error);
                    }
                }, 100); // Executar em background ap√≥s 100ms
            }

            // Fun√ß√£o para processar entrada no modo fallback
            async function processFallbackInput(userInput) {
                console.log('üîÑ Processando entrada no modo fallback:', userInput);
                
                // Verificar se √© uma resposta positiva para concordar com a compra
                const positiveResponses = [
                    'sim', 'yes', 'ok', 'concordo', 'aceito', 'quero', 'vou comprar', 'comprar', 'adquirir', 
                    'vamos', 'continuar', 'claro', 'podemos', 'pode ser', 'eu quero', 'quero sim', 
                    't√° bom', 'ta bom', 'beleza', 'perfeito', '√≥timo', 'otimo', 'excelente', 
                    'vou querer', 'quero comprar', 'quero adquirir', 'me interessa', 'tenho interesse',
                    'gostaria', 'gostaria sim', 'quero saber mais', 'vou pegar', 'vou levar',
                    'fechado', 'feito', 'bora', 'vamos l√°', 'dale', 'partiu', 'top', 'show',
                    'confirmo', 'confirmado', 'certo', 'correto', 'isso mesmo', 'exato',
                    'positivo', 'afirmativo', 'com certeza', 'certeza', 'claro que sim'
                ];
                const isPositive = positiveResponses.some(response => 
                    userInput.toLowerCase().includes(response)
                );
                
                if (isPositive) {
                    console.log('‚úÖ Usu√°rio concordou - Mostrando popup final');
                    
                    // Sair do modo fallback
                    chatData.fallbackMode = false;
                    chatData.currentStep = 6; // Voltar para step de finaliza√ß√£o
                    
                    await addMessage({
                        type: 'text',
                        content: 'Perfeito! Vamos finalizar seu pedido ent√£o. üéâ',
                        sender: 'bot'
                    });
                    
                    // Mostrar popup final sem bot√£o X
                    setTimeout(() => {
                        window.showFinalPopup();
                    }, 1500);
                    
                } else {
                    // Tratar como d√∫vida e enviar para N8N
                    console.log('‚ùì Tratando como d√∫vida no modo fallback');
                    await window.sendFallbackQuestion(userInput);
                }
            }

            // Fun√ß√£o para abrir o modal de imagem
            function openImageModal(imageUrl) {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                const closeBtn = document.getElementById('imageModalClose');

                if (modal && modalImg && closeBtn) {
                    modal.style.display = 'flex';
                    modalImg.src = imageUrl;

                    const closeModal = () => {
                        modal.style.display = 'none';
                        modalImg.src = '';
                    };

                    closeBtn.onclick = closeModal;
                    
                    modal.onclick = function(event) {
                        if (event.target === modal) {
                            closeModal();
                        }
                    };
                }
            }
        });
    </script>
    
    <!-- Address Confirmation Popup -->
    <div class="address-popup" id="address-popup">
        <div class="address-popup-content">
            <div class="address-popup-header">
                <h2>Confirmar Dados de Entrega</h2>
                
                <!-- Bot√£o X para fechar o popup -->
                <button class="popup-close-btn" id="popup-close-btn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;">
                    ‚úï
                </button>
            </div>
            <div class="address-popup-body">
                <div class="offer-section" style="padding: 0; overflow: hidden; position: relative; margin-bottom: 20px;">
                    <img src="https://4lifenutrition.site/Assets/ctt_entregas.webp" alt="Entrega" class="delivery-image" id="popup-delivery-image" style="width: 100%; height: 250px; object-fit: contain; border-radius: 8px; margin: 0; border: none; background-color: #f8f8f8;">
                    
                    <!-- Cron√¥metro de urg√™ncia - s√≥ aparece no fallback -->
                    <div class="countdown-timer" id="countdown-timer" style="background: linear-gradient(45deg, #ff4757, #ff3838); color: white; padding: 8px 15px; border-radius: 20px; margin: 10px auto 0 auto; text-align: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 10px rgba(255, 71, 87, 0.3); animation: pulse-urgent 2s infinite; display: none; max-width: 200px;">
                        <div style="font-size: 12px; margin-bottom: 2px;">‚è∞ OFERTA EXPIRA EM BREVE</div>
                        <div id="countdown-display" style="font-size: 16px; font-weight: 900;">10:00</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" class="form-control readonly" id="popup-name" readonly>
                        <span class="edit-icon" id="edit-name">‚úèÔ∏è</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Telem√≥vel</label>
                        <input type="text" class="form-control readonly" id="popup-phone" readonly>
                        <span class="edit-icon" id="edit-phone">‚úèÔ∏è</span>
                    </div>
                    
                    <div class="address-block">
                        <div class="address-block-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <span>Morada de Entrega</span>
                        </div>
                        <div class="address-fields">
                            <input type="text" class="form-control" id="popup-address-street" placeholder="Rua, n√∫mero, andar" style="border: 1px solid #25D366; box-shadow: 0 0 8px rgba(37, 211, 102, 0.5); transition: all 0.3s ease;">
                            <input type="text" class="form-control" id="popup-address-postal" placeholder="C√≥digo Postal, Localidade" style="border: 1px solid #25D366; box-shadow: 0 0 8px rgba(37, 211, 102, 0.5); transition: all 0.3s ease;">
                        </div>
                    </div>
                    
                    <button class="address-submit-btn" id="confirm-address-btn" style="margin: 20px auto; width: 80%; display: block; text-align: center;">
                        CONFIRMAR ENTREGA
                    </button>
                    <div class="payment-on-delivery" style="text-align: center;">Paga s√≥ quando receber</div>
                </div>
            </div>
            <div class="popup-footer">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
                </svg>
                MB | MB WAY | Devolu√ß√£o 30 dias
            </div>
        </div>
    </div>

    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5D2R5C55"
      height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
</body>
</html>