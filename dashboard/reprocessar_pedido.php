<?php
// Garantir que nenhuma sa√≠da seja enviada antes dos cabe√ßalhos
ob_start();
session_start();

// Definir cabe√ßalhos para evitar problemas de CORS
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Desabilitar qualquer buffer de sa√≠da que possa ter sido criado
if (ob_get_length()) ob_clean();

// Fun√ß√£o para responder com JSON e sair
function json_response($data) {
    echo json_encode($data, JSON_UNESCAPED_UNICODE);
    exit;
}

// Tratar requisi√ß√µes OPTIONS (preflight)
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

// Verificar se est√° logado
if (!isset($_SESSION['usuario_id'])) {
    json_response(['success' => false, 'error' => 'N√£o autorizado']);
}

// Incluir configura√ß√µes
require_once 'config.php';

// Definir caminho para a pasta de pedidos
$pedidos_path = '../2025/pedidos'; // Caminho relativo atualizado
$index_path = $pedidos_path . '/index.json'; // Caminho para o arquivo de √≠ndice
$absolute_path = $_SERVER['DOCUMENT_ROOT'] . '/2025/pedidos'; // Caminho absoluto

// Verificar se os diret√≥rios existem
if (!is_dir($pedidos_path) && !is_dir($absolute_path)) {
    error_log("Diret√≥rios de pedidos n√£o encontrados: $pedidos_path e $absolute_path");
    json_response(['success' => false, 'error' => 'Diret√≥rio de pedidos n√£o encontrado']);
}

// Usar o caminho que existir
$local_path = is_dir($pedidos_path) ? $pedidos_path : $absolute_path;
error_log("Usando diret√≥rio de pedidos: $local_path");

// Verificar configura√ß√µes do Trello antes de continuar
if (!defined('TRELLO_API_KEY') || empty(TRELLO_API_KEY) || 
    !defined('TRELLO_TOKEN') || empty(TRELLO_TOKEN) ||
    !defined('TRELLO_BOARD_ID') || empty(TRELLO_BOARD_ID)) {
    json_response(['success' => false, 'error' => 'Configura√ß√µes do Trello incompletas']);
}

// Verificar se √© uma requisi√ß√£o POST
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    json_response(['success' => false, 'error' => 'M√©todo n√£o permitido.']);
}

// Obter dados da requisi√ß√£o
$data = json_decode(file_get_contents('php://input'), true);
if (!$data) {
    json_response(['success' => false, 'error' => 'Dados inv√°lidos.']);
}

// Extrair informa√ß√µes
$arquivo = $data['arquivo'] ?? '';
$fonte = $data['fonte'] ?? 'json';
$novo_status = $data['novo_status'] ?? 'aguardando';

// Verificar se √© um pedido do Trello ou arquivo JSON
if ($fonte === 'trello') {
    // Reprocessar pedido do Trello
    try {
        error_log("Iniciando reprocessamento de pedido do Trello com ID: $arquivo");
        
        // Obter informa√ß√µes do card atual
        $cardId = $arquivo;
        $url_card = "https://api.trello.com/1/cards/{$cardId}?key=" . TRELLO_API_KEY . "&token=" . TRELLO_TOKEN;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url_card);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        $response = curl_exec($ch);
        
        if (curl_errno($ch)) {
            $error = curl_error($ch);
            error_log("Erro ao acessar card do Trello: $error");
            curl_close($ch);
            throw new Exception('Erro ao acessar card do Trello: ' . $error);
        }
        
        curl_close($ch);
        
        $card = json_decode($response, true);
        if (!$card) {
            error_log("Erro ao decodificar resposta do Trello: " . json_last_error_msg());
            throw new Exception('Erro ao decodificar resposta do Trello: ' . json_last_error_msg());
        }
        
        error_log("Card do Trello encontrado: " . $card['name']);
        
        // Obter as listas do board para encontrar a lista "Novos Clientes"
        $url_lists = "https://api.trello.com/1/boards/" . TRELLO_BOARD_ID . "/lists?key=" . TRELLO_API_KEY . "&token=" . TRELLO_TOKEN;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url_lists);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        $response_lists = curl_exec($ch);
        
        if (curl_errno($ch)) {
            $error = curl_error($ch);
            error_log("Erro ao acessar listas do Trello: $error");
            curl_close($ch);
            throw new Exception('Erro ao acessar listas do Trello: ' . $error);
        }
        
        curl_close($ch);
        
        $lists = json_decode($response_lists, true);
        if (!is_array($lists)) {
            error_log("Erro ao obter listas do Trello: resposta n√£o √© um array");
            throw new Exception('Erro ao obter listas do Trello: resposta n√£o √© um array');
        }
        
        // Encontrar a lista "Novos Clientes" ou algo similar
        $novosClientesListId = null;
        foreach ($lists as $list) {
            error_log("Lista do Trello encontrada: " . $list['name'] . " (ID: " . $list['id'] . ")");
            if (stripos($list['name'], 'NOVO CLIENTE') !== false || 
                stripos($list['name'], 'NOVOS CLIENTES') !== false || 
                stripos($list['name'], 'AGUARDANDO') !== false) {
                $novosClientesListId = $list['id'];
                error_log("Lista 'Novos Clientes' encontrada: " . $list['name'] . " (ID: " . $list['id'] . ")");
                break;
            }
        }
        
        if (!$novosClientesListId) {
            // Usar ID espec√≠fico se n√£o encontrar a lista pelo nome
            $novosClientesListId = '67f70b1e66425a64aa863e9f';
            error_log("Lista 'Novos Clientes' n√£o encontrada pelo nome, usando ID padr√£o: $novosClientesListId");
        }
        
        // Atualizar nome do card (remover c√≥digo de rastreio se existir)
        $cardName = $card['name'];
        $originalName = $cardName;
        
        // Se o nome come√ßa com c√≥digo de rastreio (formato: C√ìDIGO - Nome), remov√™-lo
        if (preg_match('/^[A-Z0-9]{7,}\s*-\s*(.+)$/i', $cardName, $matches)) {
            $cardName = $matches[1];
            error_log("Removido c√≥digo de rastreio do nome do card: '$originalName' -> '$cardName'");
        } 
        // Remover tamb√©m se tiver formato de devolu√ß√£o
        else if (preg_match('/^DEVOLU√á√ÉO\s*-\s*(.+)$/i', $cardName, $matches)) {
            $cardName = $matches[1];
            error_log("Removido prefixo 'DEVOLU√á√ÉO' do nome do card: '$originalName' -> '$cardName'");
        }
        
        // Atualizar descri√ß√£o do card para remover informa√ß√µes de rastreio e estado
        $currentDesc = $card['desc'];
        $originalDesc = $currentDesc;
        
        // Remover linhas com "C√≥digo de Rastreio", "Estado" e "√öltima atualiza√ß√£o"
        $linhas = explode("\n", $currentDesc);
        $novasLinhas = [];
        
        foreach ($linhas as $linha) {
            if (strpos($linha, 'üìå C√≥digo de Rastreio:') === false && 
                strpos($linha, 'üîµ Estado:') === false && 
                strpos($linha, 'üïí √öltima atualiza√ß√£o:') === false) {
                $novasLinhas[] = $linha;
            } else {
                error_log("Removida linha da descri√ß√£o: '$linha'");
            }
        }
        
        $newDesc = implode("\n", $novasLinhas);
        
        if ($newDesc !== $originalDesc) {
            error_log("Descri√ß√£o do card modificada");
        }
        
        // Atualizar card
        $url_update = "https://api.trello.com/1/cards/{$cardId}?key=" . TRELLO_API_KEY . "&token=" . TRELLO_TOKEN;
        $updateData = [
            'name' => $cardName,
            'desc' => $newDesc,
            'idList' => $novosClientesListId
        ];
        
        error_log("Atualizando card do Trello para lista 'Novos Clientes' (ID: $novosClientesListId)");
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url_update);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PUT');
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($updateData));
        $response = curl_exec($ch);
        
        if (curl_errno($ch)) {
            $error = curl_error($ch);
            error_log("Erro ao atualizar card no Trello: $error");
            curl_close($ch);
            throw new Exception('Erro ao atualizar card no Trello: ' . $error);
        }
        
        curl_close($ch);
        
        // Verificar resposta
        $result = json_decode($response, true);
        if (!$result) {
            error_log("Erro ao processar resposta do Trello ap√≥s atualiza√ß√£o: " . json_last_error_msg());
            throw new Exception('Erro ao processar resposta do Trello ap√≥s atualiza√ß√£o: ' . json_last_error_msg());
        }
        
        error_log("Card do Trello atualizado com sucesso");
        
        // Sucesso ao reprocessar pedido
        json_response(['success' => true, 'message' => 'Pedido reprocessado com sucesso.']);
        
    } catch (Exception $e) {
        error_log("Erro ao reprocessar pedido do Trello: " . $e->getMessage());
        json_response(['success' => false, 'error' => $e->getMessage()]);
    }
} else {
    // Reprocessar pedido JSON
    if (empty($arquivo)) {
        error_log("Erro: arquivo n√£o informado para reprocessamento");
        json_response(['success' => false, 'error' => 'Arquivo n√£o informado.']);
    }
    
    error_log("Iniciando reprocessamento de pedido JSON: $arquivo");
    
    // Tentar v√°rios caminhos poss√≠veis para o arquivo
    $caminhos_possiveis = [
        $local_path . '/' . $arquivo,
        $_SERVER['DOCUMENT_ROOT'] . '/2025/pedidos/' . $arquivo,
        dirname($_SERVER['DOCUMENT_ROOT']) . '/2025/pedidos/' . $arquivo,
        '../../2025/pedidos/' . $arquivo
    ];
    
    $arquivo_path = null;
    foreach ($caminhos_possiveis as $caminho) {
        error_log("Verificando caminho: $caminho");
        if (file_exists($caminho)) {
            $arquivo_path = $caminho;
            error_log("Arquivo encontrado em: $caminho");
            break;
        }
    }
    
    if ($arquivo_path === null) {
        error_log("Erro: arquivo n√£o encontrado em nenhum dos caminhos tentados");
        json_response(['success' => false, 'error' => 'Arquivo n√£o encontrado. Verifique o caminho.']);
    }
    
    try {
        // Carregar o pedido atual
        $file_contents = file_get_contents($arquivo_path);
        if ($file_contents === false) {
            error_log("Erro ao ler o arquivo: $arquivo_path");
            throw new Exception('Erro ao ler o arquivo do pedido.');
        }
        
        $pedido = json_decode($file_contents, true);
        if (!$pedido) {
            error_log("Erro ao decodificar o arquivo JSON: " . json_last_error_msg());
            throw new Exception('Erro ao decodificar o arquivo JSON do pedido: ' . json_last_error_msg());
        }
        
        // Atualizar o pedido
        $pedido['status'] = $novo_status;
        $pedido['integrado'] = false;
        
        // Remover informa√ß√µes de rastreio e estado
        if (isset($pedido['rastreio'])) {
            error_log("Removendo campo 'rastreio' do pedido");
            unset($pedido['rastreio']);
        }
        if (isset($pedido['estado_encomenda'])) {
            error_log("Removendo campo 'estado_encomenda' do pedido");
            unset($pedido['estado_encomenda']);
        }
        if (isset($pedido['atualizacao'])) {
            error_log("Removendo campo 'atualizacao' do pedido");
            unset($pedido['atualizacao']);
        }
        
        // Salvar as mudan√ßas localmente
        if (!file_put_contents($arquivo_path, json_encode($pedido, JSON_PRETTY_PRINT))) {
            error_log("Erro ao salvar altera√ß√µes no arquivo: $arquivo_path");
            throw new Exception('Erro ao salvar as altera√ß√µes no arquivo do pedido.');
        }
        
        error_log("Pedido atualizado com sucesso no arquivo");
        
        // Atualizar o √≠ndice
        if (atualizarIndice($pedido, $arquivo)) {
            error_log("√çndice atualizado com sucesso");
        } else {
            error_log("Aviso: √çndice n√£o p√¥de ser atualizado, mas o pedido foi reprocessado");
        }
        
        // Retornar sucesso
        json_response(['success' => true, 'message' => 'Pedido reprocessado com sucesso e movido para Novos Clientes.']);
        exit;
    } catch (Exception $e) {
        error_log("Erro ao reprocessar pedido JSON: " . $e->getMessage());
        json_response(['success' => false, 'error' => $e->getMessage()]);
    }
}

// Fun√ß√£o para atualizar o √≠ndice
function atualizarIndice($pedido, $arquivo) {
    $pedidos_path = '/2025/pedidos';
    $index_path = $pedidos_path . '/index.json';
    
    try {
        // Carregar √≠ndice existente ou criar novo
        $index_content = @file_get_contents($index_path);
        if ($index_content !== false) {
            $index = json_decode($index_content, true);
            if (!is_array($index)) {
                $index = [];
            }
        } else {
            // Tentar com caminho relativo √† raiz do servidor
            $index_path_alt = $_SERVER['DOCUMENT_ROOT'] . $index_path;
            $index_content = @file_get_contents($index_path_alt);
            
            if ($index_content !== false) {
                $index = json_decode($index_content, true);
                if (!is_array($index)) {
                    $index = [];
                }
            } else {
                $index = [];
            }
        }
        
        // Verificar se o pedido j√° existe no √≠ndice
        $found = false;
        foreach ($index as $key => $item) {
            if (isset($item['arquivo']) && $item['arquivo'] === $arquivo) {
                // Atualizar o pedido existente
                $index[$key] = $pedido;
                $index[$key]['arquivo'] = $arquivo;
                $found = true;
                break;
            }
        }
        
        // Se n√£o encontrou, adicionar ao √≠ndice
        if (!$found) {
            $pedido['arquivo'] = $arquivo;
            $index[] = $pedido;
        }
        
        // Salvar o √≠ndice atualizado - como pode ser que n√£o tenhamos permiss√£o para escrita,
        // apenas logamos a tentativa de atualiza√ß√£o
        $resultado = @file_put_contents($index_path, json_encode($index));
        if (!$resultado) {
            $index_path_alt = $_SERVER['DOCUMENT_ROOT'] . $index_path;
            $resultado = @file_put_contents($index_path_alt, json_encode($index));
            if (!$resultado) {
                error_log('Aviso: N√£o foi poss√≠vel escrever no arquivo de √≠ndice: ' . $index_path);
                // N√£o lan√ßamos uma exce√ß√£o aqui, apenas registramos o erro
            }
        }
        
        return true;
    } catch (Exception $e) {
        error_log('Erro ao atualizar √≠ndice: ' . $e->getMessage());
        return false;
    }
} 